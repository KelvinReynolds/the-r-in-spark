<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Tuning | Mastering Spark with R</title>
  <meta name="description" content="The Complete Guide to Large-Scale Analysis and Modeling." />
  <meta name="generator" content="bookdown 0.13 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Tuning | Mastering Spark with R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="The Complete Guide to Large-Scale Analysis and Modeling." />
  <meta name="github-repo" content="r-spark/the-r-in-spark" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Tuning | Mastering Spark with R" />
  
  <meta name="twitter:description" content="The Complete Guide to Large-Scale Analysis and Modeling." />
  

<meta name="author" content="Javier Luraschi, Kevin Kuo, Edgar Ruiz" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="data.html"/>
<link rel="next" href="extensions.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-119986300-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-119986300-1');
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><strong><a href="./">Mastering Spark with R</a></strong></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#intro-background"><i class="fa fa-check"></i><b>1.1</b> Overview</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#intro-hadoop"><i class="fa fa-check"></i><b>1.2</b> Hadoop</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#intro-spark"><i class="fa fa-check"></i><b>1.3</b> Spark</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#intro-r"><i class="fa fa-check"></i><b>1.4</b> R</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#intro-sparklyr"><i class="fa fa-check"></i><b>1.5</b> sparklyr</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#intro-recap"><i class="fa fa-check"></i><b>1.6</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="starting.html"><a href="starting.html"><i class="fa fa-check"></i><b>2</b> Getting Started</a><ul>
<li class="chapter" data-level="2.1" data-path="starting.html"><a href="starting.html#overview"><i class="fa fa-check"></i><b>2.1</b> Overview</a></li>
<li class="chapter" data-level="2.2" data-path="starting.html"><a href="starting.html#starting-prerequisites"><i class="fa fa-check"></i><b>2.2</b> Prerequisites</a><ul>
<li class="chapter" data-level="2.2.1" data-path="starting.html"><a href="starting.html#starting-install-sparklyr"><i class="fa fa-check"></i><b>2.2.1</b> Installing sparklyr</a></li>
<li class="chapter" data-level="2.2.2" data-path="starting.html"><a href="starting.html#starting-installing-spark"><i class="fa fa-check"></i><b>2.2.2</b> Installing Spark</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="starting.html"><a href="starting.html#starting-connect-to-spark"><i class="fa fa-check"></i><b>2.3</b> Connecting</a></li>
<li class="chapter" data-level="2.4" data-path="starting.html"><a href="starting.html#starting-sparklyr-hello-world"><i class="fa fa-check"></i><b>2.4</b> Using Spark</a><ul>
<li class="chapter" data-level="2.4.1" data-path="starting.html"><a href="starting.html#starting-spark-web-interface"><i class="fa fa-check"></i><b>2.4.1</b> Web Interface</a></li>
<li class="chapter" data-level="2.4.2" data-path="starting.html"><a href="starting.html#starting-analysis"><i class="fa fa-check"></i><b>2.4.2</b> Analysis</a></li>
<li class="chapter" data-level="2.4.3" data-path="starting.html"><a href="starting.html#starting-modeling"><i class="fa fa-check"></i><b>2.4.3</b> Modeling</a></li>
<li class="chapter" data-level="2.4.4" data-path="starting.html"><a href="starting.html#starting-data"><i class="fa fa-check"></i><b>2.4.4</b> Data</a></li>
<li class="chapter" data-level="2.4.5" data-path="starting.html"><a href="starting.html#starting-extensions"><i class="fa fa-check"></i><b>2.4.5</b> Extensions</a></li>
<li class="chapter" data-level="2.4.6" data-path="starting.html"><a href="starting.html#starting-distributed-r"><i class="fa fa-check"></i><b>2.4.6</b> Distributed R</a></li>
<li class="chapter" data-level="2.4.7" data-path="starting.html"><a href="starting.html#starting-streaming"><i class="fa fa-check"></i><b>2.4.7</b> Streaming</a></li>
<li class="chapter" data-level="2.4.8" data-path="starting.html"><a href="starting.html#starting-logs"><i class="fa fa-check"></i><b>2.4.8</b> Logs</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="starting.html"><a href="starting.html#starting-disconnecting"><i class="fa fa-check"></i><b>2.5</b> Disconnecting</a></li>
<li class="chapter" data-level="2.6" data-path="starting.html"><a href="starting.html#starting-using-spark-from-rstudio"><i class="fa fa-check"></i><b>2.6</b> Using RStudio</a></li>
<li class="chapter" data-level="2.7" data-path="starting.html"><a href="starting.html#starting-resources"><i class="fa fa-check"></i><b>2.7</b> Resources</a></li>
<li class="chapter" data-level="2.8" data-path="starting.html"><a href="starting.html#starting-recap"><i class="fa fa-check"></i><b>2.8</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="analysis.html"><a href="analysis.html"><i class="fa fa-check"></i><b>3</b> Analysis</a><ul>
<li class="chapter" data-level="3.1" data-path="analysis.html"><a href="analysis.html#analysis-overview"><i class="fa fa-check"></i><b>3.1</b> Overview</a></li>
<li class="chapter" data-level="3.2" data-path="analysis.html"><a href="analysis.html#import"><i class="fa fa-check"></i><b>3.2</b> Import</a></li>
<li class="chapter" data-level="3.3" data-path="analysis.html"><a href="analysis.html#wrangle"><i class="fa fa-check"></i><b>3.3</b> Wrangle</a><ul>
<li class="chapter" data-level="3.3.1" data-path="analysis.html"><a href="analysis.html#built-in-functions"><i class="fa fa-check"></i><b>3.3.1</b> Built-in Functions</a></li>
<li class="chapter" data-level="3.3.2" data-path="analysis.html"><a href="analysis.html#correlations"><i class="fa fa-check"></i><b>3.3.2</b> Correlations</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="analysis.html"><a href="analysis.html#visualize"><i class="fa fa-check"></i><b>3.4</b> Visualize</a><ul>
<li class="chapter" data-level="3.4.1" data-path="analysis.html"><a href="analysis.html#using-ggplot2"><i class="fa fa-check"></i><b>3.4.1</b> Using ggplot2</a></li>
<li class="chapter" data-level="3.4.2" data-path="analysis.html"><a href="analysis.html#using-dbplot"><i class="fa fa-check"></i><b>3.4.2</b> Using dbplot</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="analysis.html"><a href="analysis.html#model"><i class="fa fa-check"></i><b>3.5</b> Model</a><ul>
<li class="chapter" data-level="3.5.1" data-path="analysis.html"><a href="analysis.html#caching"><i class="fa fa-check"></i><b>3.5.1</b> Caching</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="analysis.html"><a href="analysis.html#communicate"><i class="fa fa-check"></i><b>3.6</b> Communicate</a></li>
<li class="chapter" data-level="3.7" data-path="analysis.html"><a href="analysis.html#recap"><i class="fa fa-check"></i><b>3.7</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="modeling.html"><a href="modeling.html"><i class="fa fa-check"></i><b>4</b> Modeling</a><ul>
<li class="chapter" data-level="4.1" data-path="modeling.html"><a href="modeling.html#overview-1"><i class="fa fa-check"></i><b>4.1</b> Overview</a></li>
<li class="chapter" data-level="4.2" data-path="modeling.html"><a href="modeling.html#exploratory-data-analysis"><i class="fa fa-check"></i><b>4.2</b> Exploratory Data Analysis</a></li>
<li class="chapter" data-level="4.3" data-path="modeling.html"><a href="modeling.html#feature-engineering"><i class="fa fa-check"></i><b>4.3</b> Feature Engineering</a></li>
<li class="chapter" data-level="4.4" data-path="modeling.html"><a href="modeling.html#supervised-learning"><i class="fa fa-check"></i><b>4.4</b> Supervised Learning</a><ul>
<li class="chapter" data-level="4.4.1" data-path="modeling.html"><a href="modeling.html#generalized-linear-regression"><i class="fa fa-check"></i><b>4.4.1</b> Generalized Linear Regression</a></li>
<li class="chapter" data-level="4.4.2" data-path="modeling.html"><a href="modeling.html#other-models"><i class="fa fa-check"></i><b>4.4.2</b> Other Models</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="modeling.html"><a href="modeling.html#unsupervised-learning"><i class="fa fa-check"></i><b>4.5</b> Unsupervised Learning</a><ul>
<li class="chapter" data-level="4.5.1" data-path="modeling.html"><a href="modeling.html#data-preparation"><i class="fa fa-check"></i><b>4.5.1</b> Data Preparation</a></li>
<li class="chapter" data-level="4.5.2" data-path="modeling.html"><a href="modeling.html#topic-modeling"><i class="fa fa-check"></i><b>4.5.2</b> Topic Modeling</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="modeling.html"><a href="modeling.html#recap-1"><i class="fa fa-check"></i><b>4.6</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="pipelines.html"><a href="pipelines.html"><i class="fa fa-check"></i><b>5</b> Pipelines</a><ul>
<li class="chapter" data-level="5.1" data-path="pipelines.html"><a href="pipelines.html#overview-2"><i class="fa fa-check"></i><b>5.1</b> Overview</a></li>
<li class="chapter" data-level="5.2" data-path="pipelines.html"><a href="pipelines.html#creation"><i class="fa fa-check"></i><b>5.2</b> Creation</a></li>
<li class="chapter" data-level="5.3" data-path="pipelines.html"><a href="pipelines.html#use-cases"><i class="fa fa-check"></i><b>5.3</b> Use Cases</a><ul>
<li class="chapter" data-level="5.3.1" data-path="pipelines.html"><a href="pipelines.html#hyperparameter-tuning"><i class="fa fa-check"></i><b>5.3.1</b> Hyperparameter Tuning</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="pipelines.html"><a href="pipelines.html#operating-modes"><i class="fa fa-check"></i><b>5.4</b> Operating Modes</a></li>
<li class="chapter" data-level="5.5" data-path="pipelines.html"><a href="pipelines.html#interoperability"><i class="fa fa-check"></i><b>5.5</b> Interoperability</a></li>
<li class="chapter" data-level="5.6" data-path="pipelines.html"><a href="pipelines.html#deployment"><i class="fa fa-check"></i><b>5.6</b> Deployment</a><ul>
<li class="chapter" data-level="5.6.1" data-path="pipelines.html"><a href="pipelines.html#batch-scoring"><i class="fa fa-check"></i><b>5.6.1</b> Batch Scoring</a></li>
<li class="chapter" data-level="5.6.2" data-path="pipelines.html"><a href="pipelines.html#real-time-scoring"><i class="fa fa-check"></i><b>5.6.2</b> Real-Time Scoring</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="pipelines.html"><a href="pipelines.html#recap-2"><i class="fa fa-check"></i><b>5.7</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="clusters.html"><a href="clusters.html"><i class="fa fa-check"></i><b>6</b> Clusters</a><ul>
<li class="chapter" data-level="6.1" data-path="clusters.html"><a href="clusters.html#clusters-overview"><i class="fa fa-check"></i><b>6.1</b> Overview</a></li>
<li class="chapter" data-level="6.2" data-path="clusters.html"><a href="clusters.html#on-premise"><i class="fa fa-check"></i><b>6.2</b> On-Premise</a><ul>
<li class="chapter" data-level="6.2.1" data-path="clusters.html"><a href="clusters.html#clusters-manager"><i class="fa fa-check"></i><b>6.2.1</b> Managers</a></li>
<li class="chapter" data-level="6.2.2" data-path="clusters.html"><a href="clusters.html#distributions"><i class="fa fa-check"></i><b>6.2.2</b> Distributions</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="clusters.html"><a href="clusters.html#cloud"><i class="fa fa-check"></i><b>6.3</b> Cloud</a><ul>
<li class="chapter" data-level="6.3.1" data-path="clusters.html"><a href="clusters.html#clusters-amazon-emr"><i class="fa fa-check"></i><b>6.3.1</b> Amazon</a></li>
<li class="chapter" data-level="6.3.2" data-path="clusters.html"><a href="clusters.html#databricks"><i class="fa fa-check"></i><b>6.3.2</b> Databricks</a></li>
<li class="chapter" data-level="6.3.3" data-path="clusters.html"><a href="clusters.html#google"><i class="fa fa-check"></i><b>6.3.3</b> Google</a></li>
<li class="chapter" data-level="6.3.4" data-path="clusters.html"><a href="clusters.html#ibm"><i class="fa fa-check"></i><b>6.3.4</b> IBM</a></li>
<li class="chapter" data-level="6.3.5" data-path="clusters.html"><a href="clusters.html#microsoft"><i class="fa fa-check"></i><b>6.3.5</b> Microsoft</a></li>
<li class="chapter" data-level="6.3.6" data-path="clusters.html"><a href="clusters.html#qubole"><i class="fa fa-check"></i><b>6.3.6</b> Qubole</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="clusters.html"><a href="clusters.html#kubernetes"><i class="fa fa-check"></i><b>6.4</b> Kubernetes</a></li>
<li class="chapter" data-level="6.5" data-path="clusters.html"><a href="clusters.html#tools"><i class="fa fa-check"></i><b>6.5</b> Tools</a><ul>
<li class="chapter" data-level="6.5.1" data-path="clusters.html"><a href="clusters.html#rstudio"><i class="fa fa-check"></i><b>6.5.1</b> RStudio</a></li>
<li class="chapter" data-level="6.5.2" data-path="clusters.html"><a href="clusters.html#jupyter"><i class="fa fa-check"></i><b>6.5.2</b> Jupyter</a></li>
<li class="chapter" data-level="6.5.3" data-path="clusters.html"><a href="clusters.html#clusters-livy"><i class="fa fa-check"></i><b>6.5.3</b> Livy</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="clusters.html"><a href="clusters.html#recap-3"><i class="fa fa-check"></i><b>6.6</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="connections.html"><a href="connections.html"><i class="fa fa-check"></i><b>7</b> Connections</a><ul>
<li class="chapter" data-level="7.1" data-path="connections.html"><a href="connections.html#connections-overview"><i class="fa fa-check"></i><b>7.1</b> Overview</a><ul>
<li class="chapter" data-level="7.1.1" data-path="connections.html"><a href="connections.html#connections-spark-edge-nodes"><i class="fa fa-check"></i><b>7.1.1</b> Edge Nodes</a></li>
<li class="chapter" data-level="7.1.2" data-path="connections.html"><a href="connections.html#connections-spark-home"><i class="fa fa-check"></i><b>7.1.2</b> Spark Home</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="connections.html"><a href="connections.html#connections-local"><i class="fa fa-check"></i><b>7.2</b> Local</a></li>
<li class="chapter" data-level="7.3" data-path="connections.html"><a href="connections.html#connections-standalone"><i class="fa fa-check"></i><b>7.3</b> Standalone</a></li>
<li class="chapter" data-level="7.4" data-path="connections.html"><a href="connections.html#connections-yarn"><i class="fa fa-check"></i><b>7.4</b> Yarn</a><ul>
<li class="chapter" data-level="7.4.1" data-path="connections.html"><a href="connections.html#connections-yarn-client"><i class="fa fa-check"></i><b>7.4.1</b> Yarn Client</a></li>
<li class="chapter" data-level="7.4.2" data-path="connections.html"><a href="connections.html#connections-yarn-cluster"><i class="fa fa-check"></i><b>7.4.2</b> Yarn Cluster</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="connections.html"><a href="connections.html#connections-livy"><i class="fa fa-check"></i><b>7.5</b> Livy</a></li>
<li class="chapter" data-level="7.6" data-path="connections.html"><a href="connections.html#connections-mesos"><i class="fa fa-check"></i><b>7.6</b> Mesos</a></li>
<li class="chapter" data-level="7.7" data-path="connections.html"><a href="connections.html#connections-kubernetes"><i class="fa fa-check"></i><b>7.7</b> Kubernetes</a></li>
<li class="chapter" data-level="7.8" data-path="connections.html"><a href="connections.html#cloud-1"><i class="fa fa-check"></i><b>7.8</b> Cloud</a></li>
<li class="chapter" data-level="7.9" data-path="connections.html"><a href="connections.html#batches"><i class="fa fa-check"></i><b>7.9</b> Batches</a></li>
<li class="chapter" data-level="7.10" data-path="connections.html"><a href="connections.html#tools-1"><i class="fa fa-check"></i><b>7.10</b> Tools</a></li>
<li class="chapter" data-level="7.11" data-path="connections.html"><a href="connections.html#multiple"><i class="fa fa-check"></i><b>7.11</b> Multiple</a></li>
<li class="chapter" data-level="7.12" data-path="connections.html"><a href="connections.html#connections-troubleshooting"><i class="fa fa-check"></i><b>7.12</b> Troubleshooting</a><ul>
<li class="chapter" data-level="7.12.1" data-path="connections.html"><a href="connections.html#logging"><i class="fa fa-check"></i><b>7.12.1</b> Logging</a></li>
<li class="chapter" data-level="7.12.2" data-path="connections.html"><a href="connections.html#connections-troubleshoot-spark-submit"><i class="fa fa-check"></i><b>7.12.2</b> Spark Submit</a></li>
<li class="chapter" data-level="7.12.3" data-path="connections.html"><a href="connections.html#windows"><i class="fa fa-check"></i><b>7.12.3</b> Windows</a></li>
</ul></li>
<li class="chapter" data-level="7.13" data-path="connections.html"><a href="connections.html#recap-4"><i class="fa fa-check"></i><b>7.13</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>8</b> Data</a><ul>
<li class="chapter" data-level="8.1" data-path="data.html"><a href="data.html#overview-3"><i class="fa fa-check"></i><b>8.1</b> Overview</a></li>
<li class="chapter" data-level="8.2" data-path="data.html"><a href="data.html#reading-data"><i class="fa fa-check"></i><b>8.2</b> Reading Data</a><ul>
<li class="chapter" data-level="8.2.1" data-path="data.html"><a href="data.html#paths"><i class="fa fa-check"></i><b>8.2.1</b> Paths</a></li>
<li class="chapter" data-level="8.2.2" data-path="data.html"><a href="data.html#schema"><i class="fa fa-check"></i><b>8.2.2</b> Schema</a></li>
<li class="chapter" data-level="8.2.3" data-path="data.html"><a href="data.html#memory"><i class="fa fa-check"></i><b>8.2.3</b> Memory</a></li>
<li class="chapter" data-level="8.2.4" data-path="data.html"><a href="data.html#columns"><i class="fa fa-check"></i><b>8.2.4</b> Columns</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="data.html"><a href="data.html#writing-data"><i class="fa fa-check"></i><b>8.3</b> Writing Data</a></li>
<li class="chapter" data-level="8.4" data-path="data.html"><a href="data.html#copy"><i class="fa fa-check"></i><b>8.4</b> Copy</a></li>
<li class="chapter" data-level="8.5" data-path="data.html"><a href="data.html#data-file-formats"><i class="fa fa-check"></i><b>8.5</b> File Formats</a><ul>
<li class="chapter" data-level="8.5.1" data-path="data.html"><a href="data.html#csv"><i class="fa fa-check"></i><b>8.5.1</b> CSV</a></li>
<li class="chapter" data-level="8.5.2" data-path="data.html"><a href="data.html#json"><i class="fa fa-check"></i><b>8.5.2</b> JSON</a></li>
<li class="chapter" data-level="8.5.3" data-path="data.html"><a href="data.html#parquet"><i class="fa fa-check"></i><b>8.5.3</b> Parquet</a></li>
<li class="chapter" data-level="8.5.4" data-path="data.html"><a href="data.html#others"><i class="fa fa-check"></i><b>8.5.4</b> Others</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="data.html"><a href="data.html#data-file-systems"><i class="fa fa-check"></i><b>8.6</b> File Systems</a></li>
<li class="chapter" data-level="8.7" data-path="data.html"><a href="data.html#data-storage-systems"><i class="fa fa-check"></i><b>8.7</b> Storage Systems</a><ul>
<li class="chapter" data-level="8.7.1" data-path="data.html"><a href="data.html#hive"><i class="fa fa-check"></i><b>8.7.1</b> Hive</a></li>
<li class="chapter" data-level="8.7.2" data-path="data.html"><a href="data.html#cassandra"><i class="fa fa-check"></i><b>8.7.2</b> Cassandra</a></li>
<li class="chapter" data-level="8.7.3" data-path="data.html"><a href="data.html#jdbc"><i class="fa fa-check"></i><b>8.7.3</b> JDBC</a></li>
</ul></li>
<li class="chapter" data-level="8.8" data-path="data.html"><a href="data.html#recap-5"><i class="fa fa-check"></i><b>8.8</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="tuning.html"><a href="tuning.html"><i class="fa fa-check"></i><b>9</b> Tuning</a><ul>
<li class="chapter" data-level="9.1" data-path="tuning.html"><a href="tuning.html#overview-4"><i class="fa fa-check"></i><b>9.1</b> Overview</a><ul>
<li class="chapter" data-level="9.1.1" data-path="tuning.html"><a href="tuning.html#tuning-graph-visualization"><i class="fa fa-check"></i><b>9.1.1</b> Graph</a></li>
<li class="chapter" data-level="9.1.2" data-path="tuning.html"><a href="tuning.html#tuning-event-timeline"><i class="fa fa-check"></i><b>9.1.2</b> Timeline</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="tuning.html"><a href="tuning.html#tuning-configuring"><i class="fa fa-check"></i><b>9.2</b> Configuring</a><ul>
<li class="chapter" data-level="9.2.1" data-path="tuning.html"><a href="tuning.html#connect-settings"><i class="fa fa-check"></i><b>9.2.1</b> Connect Settings</a></li>
<li class="chapter" data-level="9.2.2" data-path="tuning.html"><a href="tuning.html#submit-settings"><i class="fa fa-check"></i><b>9.2.2</b> Submit Settings</a></li>
<li class="chapter" data-level="9.2.3" data-path="tuning.html"><a href="tuning.html#runtime-settings"><i class="fa fa-check"></i><b>9.2.3</b> Runtime Settings</a></li>
<li class="chapter" data-level="9.2.4" data-path="tuning.html"><a href="tuning.html#sparklyr-settings"><i class="fa fa-check"></i><b>9.2.4</b> sparklyr Settings</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="tuning.html"><a href="tuning.html#tuning-partitioning"><i class="fa fa-check"></i><b>9.3</b> Partitioning</a><ul>
<li class="chapter" data-level="9.3.1" data-path="tuning.html"><a href="tuning.html#implicit-partitions"><i class="fa fa-check"></i><b>9.3.1</b> Implicit Partitions</a></li>
<li class="chapter" data-level="9.3.2" data-path="tuning.html"><a href="tuning.html#explicit-partitions"><i class="fa fa-check"></i><b>9.3.2</b> Explicit Partitions</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="tuning.html"><a href="tuning.html#tuning-caching"><i class="fa fa-check"></i><b>9.4</b> Caching</a><ul>
<li class="chapter" data-level="9.4.1" data-path="tuning.html"><a href="tuning.html#checkpointing"><i class="fa fa-check"></i><b>9.4.1</b> Checkpointing</a></li>
<li class="chapter" data-level="9.4.2" data-path="tuning.html"><a href="tuning.html#tuning-memory"><i class="fa fa-check"></i><b>9.4.2</b> Memory</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="tuning.html"><a href="tuning.html#tuning-shuffling"><i class="fa fa-check"></i><b>9.5</b> Shuffling</a></li>
<li class="chapter" data-level="9.6" data-path="tuning.html"><a href="tuning.html#tuning-serialization"><i class="fa fa-check"></i><b>9.6</b> Serialization</a></li>
<li class="chapter" data-level="9.7" data-path="tuning.html"><a href="tuning.html#configuration-files"><i class="fa fa-check"></i><b>9.7</b> Configuration Files</a></li>
<li class="chapter" data-level="9.8" data-path="tuning.html"><a href="tuning.html#recap-6"><i class="fa fa-check"></i><b>9.8</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="extensions.html"><a href="extensions.html"><i class="fa fa-check"></i><b>10</b> Extensions</a><ul>
<li class="chapter" data-level="10.1" data-path="extensions.html"><a href="extensions.html#overview-5"><i class="fa fa-check"></i><b>10.1</b> Overview</a></li>
<li class="chapter" data-level="10.2" data-path="extensions.html"><a href="extensions.html#h2o"><i class="fa fa-check"></i><b>10.2</b> H2O</a></li>
<li class="chapter" data-level="10.3" data-path="extensions.html"><a href="extensions.html#graphs"><i class="fa fa-check"></i><b>10.3</b> Graphs</a></li>
<li class="chapter" data-level="10.4" data-path="extensions.html"><a href="extensions.html#xgboost"><i class="fa fa-check"></i><b>10.4</b> XGBoost</a></li>
<li class="chapter" data-level="10.5" data-path="extensions.html"><a href="extensions.html#deep-learning"><i class="fa fa-check"></i><b>10.5</b> Deep Learning</a></li>
<li class="chapter" data-level="10.6" data-path="extensions.html"><a href="extensions.html#genomics"><i class="fa fa-check"></i><b>10.6</b> Genomics</a></li>
<li class="chapter" data-level="10.7" data-path="extensions.html"><a href="extensions.html#spatial"><i class="fa fa-check"></i><b>10.7</b> Spatial</a></li>
<li class="chapter" data-level="10.8" data-path="extensions.html"><a href="extensions.html#troubleshooting"><i class="fa fa-check"></i><b>10.8</b> Troubleshooting</a></li>
<li class="chapter" data-level="10.9" data-path="extensions.html"><a href="extensions.html#recap-7"><i class="fa fa-check"></i><b>10.9</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="distributed.html"><a href="distributed.html"><i class="fa fa-check"></i><b>11</b> Distributed R</a><ul>
<li class="chapter" data-level="11.1" data-path="distributed.html"><a href="distributed.html#overview-6"><i class="fa fa-check"></i><b>11.1</b> Overview</a></li>
<li class="chapter" data-level="11.2" data-path="distributed.html"><a href="distributed.html#use-cases-1"><i class="fa fa-check"></i><b>11.2</b> Use Cases</a><ul>
<li class="chapter" data-level="11.2.1" data-path="distributed.html"><a href="distributed.html#custom-parsers"><i class="fa fa-check"></i><b>11.2.1</b> Custom Parsers</a></li>
<li class="chapter" data-level="11.2.2" data-path="distributed.html"><a href="distributed.html#partitioned-modeling"><i class="fa fa-check"></i><b>11.2.2</b> Partitioned Modeling</a></li>
<li class="chapter" data-level="11.2.3" data-path="distributed.html"><a href="distributed.html#distributed-grid-search"><i class="fa fa-check"></i><b>11.2.3</b> Grid Search</a></li>
<li class="chapter" data-level="11.2.4" data-path="distributed.html"><a href="distributed.html#web-apis"><i class="fa fa-check"></i><b>11.2.4</b> Web APIs</a></li>
<li class="chapter" data-level="11.2.5" data-path="distributed.html"><a href="distributed.html#simulations"><i class="fa fa-check"></i><b>11.2.5</b> Simulations</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="distributed.html"><a href="distributed.html#partitions"><i class="fa fa-check"></i><b>11.3</b> Partitions</a></li>
<li class="chapter" data-level="11.4" data-path="distributed.html"><a href="distributed.html#grouping"><i class="fa fa-check"></i><b>11.4</b> Grouping</a></li>
<li class="chapter" data-level="11.5" data-path="distributed.html"><a href="distributed.html#columns-1"><i class="fa fa-check"></i><b>11.5</b> Columns</a></li>
<li class="chapter" data-level="11.6" data-path="distributed.html"><a href="distributed.html#context"><i class="fa fa-check"></i><b>11.6</b> Context</a></li>
<li class="chapter" data-level="11.7" data-path="distributed.html"><a href="distributed.html#functions"><i class="fa fa-check"></i><b>11.7</b> Functions</a></li>
<li class="chapter" data-level="11.8" data-path="distributed.html"><a href="distributed.html#packages"><i class="fa fa-check"></i><b>11.8</b> Packages</a></li>
<li class="chapter" data-level="11.9" data-path="distributed.html"><a href="distributed.html#cluster-requirements"><i class="fa fa-check"></i><b>11.9</b> Cluster Requirements</a><ul>
<li class="chapter" data-level="11.9.1" data-path="distributed.html"><a href="distributed.html#installing-r"><i class="fa fa-check"></i><b>11.9.1</b> Installing R</a></li>
<li class="chapter" data-level="11.9.2" data-path="distributed.html"><a href="distributed.html#apache-arrow"><i class="fa fa-check"></i><b>11.9.2</b> Apache Arrow</a></li>
</ul></li>
<li class="chapter" data-level="11.10" data-path="distributed.html"><a href="distributed.html#troubleshooting-1"><i class="fa fa-check"></i><b>11.10</b> Troubleshooting</a><ul>
<li class="chapter" data-level="11.10.1" data-path="distributed.html"><a href="distributed.html#worker-logs"><i class="fa fa-check"></i><b>11.10.1</b> Worker Logs</a></li>
<li class="chapter" data-level="11.10.2" data-path="distributed.html"><a href="distributed.html#resolving-timeouts"><i class="fa fa-check"></i><b>11.10.2</b> Resolving Timeouts</a></li>
<li class="chapter" data-level="11.10.3" data-path="distributed.html"><a href="distributed.html#inspecting-partitions"><i class="fa fa-check"></i><b>11.10.3</b> Inspecting Partitions</a></li>
<li class="chapter" data-level="11.10.4" data-path="distributed.html"><a href="distributed.html#debugging-workers"><i class="fa fa-check"></i><b>11.10.4</b> Debugging Workers</a></li>
</ul></li>
<li class="chapter" data-level="11.11" data-path="distributed.html"><a href="distributed.html#recap-8"><i class="fa fa-check"></i><b>11.11</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="streaming.html"><a href="streaming.html"><i class="fa fa-check"></i><b>12</b> Streaming</a><ul>
<li class="chapter" data-level="12.1" data-path="streaming.html"><a href="streaming.html#overview-7"><i class="fa fa-check"></i><b>12.1</b> Overview</a></li>
<li class="chapter" data-level="12.2" data-path="streaming.html"><a href="streaming.html#transformations"><i class="fa fa-check"></i><b>12.2</b> Transformations</a><ul>
<li class="chapter" data-level="12.2.1" data-path="streaming.html"><a href="streaming.html#analysis-1"><i class="fa fa-check"></i><b>12.2.1</b> Analysis</a></li>
<li class="chapter" data-level="12.2.2" data-path="streaming.html"><a href="streaming.html#modeling-1"><i class="fa fa-check"></i><b>12.2.2</b> Modeling</a></li>
<li class="chapter" data-level="12.2.3" data-path="streaming.html"><a href="streaming.html#pipelines-1"><i class="fa fa-check"></i><b>12.2.3</b> Pipelines</a></li>
<li class="chapter" data-level="12.2.4" data-path="streaming.html"><a href="streaming.html#distributed-r-streaming-r-code"><i class="fa fa-check"></i><b>12.2.4</b> Distributed R {streaming-r-code}</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="streaming.html"><a href="streaming.html#kafka"><i class="fa fa-check"></i><b>12.3</b> Kafka</a></li>
<li class="chapter" data-level="12.4" data-path="streaming.html"><a href="streaming.html#shiny"><i class="fa fa-check"></i><b>12.4</b> Shiny</a></li>
<li class="chapter" data-level="12.5" data-path="streaming.html"><a href="streaming.html#recap-9"><i class="fa fa-check"></i><b>12.5</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="contributing.html"><a href="contributing.html"><i class="fa fa-check"></i><b>13</b> Contributing</a><ul>
<li class="chapter" data-level="13.1" data-path="contributing.html"><a href="contributing.html#contributing-overview"><i class="fa fa-check"></i><b>13.1</b> Overview</a></li>
<li class="chapter" data-level="13.2" data-path="contributing.html"><a href="contributing.html#contributing-spark-api"><i class="fa fa-check"></i><b>13.2</b> Spark API</a></li>
<li class="chapter" data-level="13.3" data-path="contributing.html"><a href="contributing.html#spark-extensions"><i class="fa fa-check"></i><b>13.3</b> Spark Extensions</a></li>
<li class="chapter" data-level="13.4" data-path="contributing.html"><a href="contributing.html#scala-code"><i class="fa fa-check"></i><b>13.4</b> Scala Code</a></li>
<li class="chapter" data-level="13.5" data-path="contributing.html"><a href="contributing.html#recap-10"><i class="fa fa-check"></i><b>13.5</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>14</b> Appendix</a><ul>
<li class="chapter" data-level="14.1" data-path="appendix.html"><a href="appendix.html#appendix-preface"><i class="fa fa-check"></i><b>14.1</b> Preface</a><ul>
<li class="chapter" data-level="14.1.1" data-path="appendix.html"><a href="appendix.html#appendix-ggplot2-theme"><i class="fa fa-check"></i><b>14.1.1</b> Formatting</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="appendix.html"><a href="appendix.html#appendix-intro"><i class="fa fa-check"></i><b>14.2</b> Introduction</a><ul>
<li class="chapter" data-level="14.2.1" data-path="appendix.html"><a href="appendix.html#appendix-storage-capacity"><i class="fa fa-check"></i><b>14.2.1</b> Worlds Store Capacity</a></li>
<li class="chapter" data-level="14.2.2" data-path="appendix.html"><a href="appendix.html#appendix-cran-downloads"><i class="fa fa-check"></i><b>14.2.2</b> Daily downloads of CRAN packages</a></li>
</ul></li>
<li class="chapter" data-level="14.3" data-path="appendix.html"><a href="appendix.html#appendix-starting"><i class="fa fa-check"></i><b>14.3</b> Getting Started</a><ul>
<li class="chapter" data-level="14.3.1" data-path="appendix.html"><a href="appendix.html#appendix-prerequisites"><i class="fa fa-check"></i><b>14.3.1</b> Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="appendix.html"><a href="appendix.html#appendix-analysis"><i class="fa fa-check"></i><b>14.4</b> Analysis</a><ul>
<li class="chapter" data-level="14.4.1" data-path="appendix.html"><a href="appendix.html#hive-functions"><i class="fa fa-check"></i><b>14.4.1</b> Hive Functions</a></li>
</ul></li>
<li class="chapter" data-level="14.5" data-path="appendix.html"><a href="appendix.html#appendix-modeling"><i class="fa fa-check"></i><b>14.5</b> Modeling</a><ul>
<li class="chapter" data-level="14.5.1" data-path="appendix.html"><a href="appendix.html#appendix-ml-functionlist"><i class="fa fa-check"></i><b>14.5.1</b> MLlib Functions</a></li>
</ul></li>
<li class="chapter" data-level="14.6" data-path="appendix.html"><a href="appendix.html#appendix-clusters"><i class="fa fa-check"></i><b>14.6</b> Clusters</a><ul>
<li class="chapter" data-level="14.6.1" data-path="appendix.html"><a href="appendix.html#appendix-cluster-trends"><i class="fa fa-check"></i><b>14.6.1</b> Google trends for mainframes, cloud computing and kubernetes</a></li>
</ul></li>
<li class="chapter" data-level="14.7" data-path="appendix.html"><a href="appendix.html#appendix-streaming"><i class="fa fa-check"></i><b>14.7</b> Streaming</a><ul>
<li class="chapter" data-level="14.7.1" data-path="appendix.html"><a href="appendix.html#appendix-streaming-generator"><i class="fa fa-check"></i><b>14.7.1</b> Stream Generator</a></li>
<li class="chapter" data-level="14.7.2" data-path="appendix.html"><a href="appendix.html#appendix-streaming-kafka"><i class="fa fa-check"></i><b>14.7.2</b> Installing Kafka</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>15</b> References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Mastering Spark with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tuning" class="section level1">
<h1><span class="header-section-number">Chapter 9</span> Tuning</h1>
<blockquote>
<p>Chaos isn’t a pit. Chaos is a ladder.</p>
<p>— Petyr Baelish</p>
</blockquote>
<p>In previous chapters, we’ve assumed that computation within a Spark cluster works efficiently. While this is true in some cases, it is often necessary to have some knowledge of the operations Spark runs internally to fine-tune configuration settings that will make computations run efficiently. This chapter explains how Spark computes data over large datasets and provides details on how to optimize its operations.</p>
<p>For instance, in this chapter you’ll learn how to request more compute nodes and increase the amount of memory, which, if you remember from <a href="starting.html#starting">Chapter 2</a>, defaults to only 2 GB in local instances. You will learn how Spark unifies computation through partitioning, shuffling, and caching. As mentioned a few chapters back, this is the last chapter describing the internals of Spark; after you complete this chapter, we believe that you will have the intermediate Spark skills necessary to be productive at using Spark.</p>
<p>In Chapters <a href="extensions.html#extensions">10</a>–<a href="streaming.html#streaming">12</a> we explore exciting techniques to deal with specific modeling, scaling, and computation problems. However, we must first understand how Spark performs internal computations, what pieces we can control, and why.</p>
<div id="overview-4" class="section level2">
<h2><span class="header-section-number">9.1</span> Overview</h2>
<p>Spark<!--((("tuning", "overview of", id="Tover09")))--> performs distributed computation by configuring, partitioning, executing, shuffling, caching, and serializing data, tasks, and resources across multiple machines:</p>
<ul>
<li><a href="tuning.html#tuning-configuring"><em>Configuring</em></a> requests<!--((("configuring", "purpose of")))--> the cluster manager for resources: total machines, memory, and so on.</li>
<li><a href="tuning.html#tuning-configuring"><em>Partitioning</em></a> splits<!--((("partitioning", "purpose of")))--> the data among various machines. Partitions can be either implicit or explicit.</li>
<li><a href="tuning.html#tuning-configuring"><em>Executing</em></a> means<!--((("execution, defined")))--> running an arbitrary transformation over each partition.</li>
<li><a href="tuning.html#tuning-configuring"><em>Shuffling</em></a> redistributes<!--((("shuffling")))--> data to the correct machine.</li>
<li><a href="tuning.html#tuning-configuring"><em>Caching</em></a> preserves<!--((("caching", "purpose of")))--> data in memory across different computation cycles.</li>
<li><a href="#tuning-serializing"><em>Serializing</em></a> transforms<!--((("serialization", "purpose of")))--> data to be sent over the network to other workers or back to the driver node.</li>
</ul>
<p>To illustrate each concept, let’s create three partitions with unordered integers and then sort them using <code>arrange()</code>:</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb298-1" title="1">data &lt;-<span class="st"> </span><span class="kw">copy_to</span>(sc, </a>
<a class="sourceLine" id="cb298-2" title="2">  <span class="kw">data.frame</span>(<span class="dt">id =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">9</span>, <span class="dv">1</span>, <span class="dv">8</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">6</span>)),</a>
<a class="sourceLine" id="cb298-3" title="3">  <span class="dt">repartition =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb298-4" title="4"></a>
<a class="sourceLine" id="cb298-5" title="5">data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(id) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collect</span>()</a></code></pre></div>
<p>Figure <a href="tuning.html#fig:tuning-overview">9.1</a> shows<!--((("job execution, process of")))--> how this<!--((("sorting operations")))--> sorting <em>job</em> would conceptually work across a cluster of machines. First, Spark would <em>configure</em> the cluster to use three worker machines. In this example, the numbers <code>1</code> through <code>9</code> are partitioned across three storage instances. Since the <em>data</em> is already partitioned, each worker node loads this implicit <em>partition</em>; for instance, <code>4</code>, <code>9</code>, and <code>1</code> are loaded in the first worker node. Afterward, a <em>task</em> is distributed to each worker to apply a transformation to each data partition in each worker node; this task is denoted by <code>f(x)</code>. In this example, <code>f(x)</code> <em>executes</em> a sorting operation within a partition. Since Spark is general, execution over a partition can be as simple or complex as needed.</p>
<p>The result is then <em>shuffled</em> to the correct machine to finish the sorting operation across the entire dataset, which completes a stage. A<!--((("stage")))--> <em>stage</em> is a set of operations that Spark can execute without shuffling data between machines. After the data is sorted across the cluster, the sorted results can be optionally <em>cached</em> in memory to avoid rerunning this computation multiple times.</p>
<p>Finally, a small subset of the results is <em>serialized</em>, through the network connecting the cluster machines, back to the driver node to print a preview of this sorting example.</p>
<p>Notice that while Figure <a href="tuning.html#fig:tuning-overview">9.1</a> describes a sorting operation, a similar approach applies to filtering or joining datasets and analyzing and modeling data at scale. Spark provides support to perform custom partitions, custom shuffling, and so on, but most of these lower-level operations are not exposed in <code>sparklyr</code>; instead, <code>sparklyr</code> makes those operations available through higher-level commands provided by data <a href="analysis.html#analysis">analysis</a> tools like <code>dplyr</code> or <code>DBI</code>, <a href="modeling.html#modeling">modeling</a>, and by using many <a href="extensions.html#extensions">extensions</a>. For those few cases in which you might need to implement low-level operations, you can always use Spark’s Scala API through <code>sparklyr</code> extensions or run custom <a href="distributed.html#distributed">distributed R</a> code.</p>
<p>To effectively tune Spark, we will start by getting familiar with Spark’s computation <a href="tuning.html#tuning-graph-visualization">graph</a> and Spark’s event <a href="tuning.html#tuning-event-timeline"><em>timeline</em></a>. Both are accessible through <a href="starting.html#starting-spark-web-interface">Spark’s web interface</a>.</p>
<div class="figure" style="text-align: center"><span id="fig:tuning-overview"></span>
<img src="images/tuning-spark-overview-resized.png" alt="Sorting distributed data with Apache Spark" width="1500" />
<p class="caption">
FIGURE 9.1: Sorting distributed data with Apache Spark
</p>
</div>
<div id="tuning-graph-visualization" class="section level3">
<h3><span class="header-section-number">9.1.1</span> Graph</h3>
<p>Spark describes<!--((("acyclic graphs")))((("Apache Spark", "computation graph")))((("Directed Acyclic Graph (DAG)")))--> all computation steps using a Directed Acyclic Graph (DAG), which means that all computations in Spark move computation forward without repeating previous steps, which helps Spark optimize computations effectively.</p>
<p>The best way to understand Spark’s computation graph for a given operation—sorting for our example—is to open the last <em>completed query</em> on the SQL tab in <a href="starting.html#starting-spark-web-interface">Spark’s web interface</a>. Figure <a href="tuning.html#fig:tuning-graph-sql-render">9.2</a> shows the resulting graph for this sorting operation, which contains the following operations:</p>
<dl>
<dt><code>WholeStageCodegen</code></dt>
<dd>This block specifies that the operations it contains were used to generate computer code that was efficiently translated to byte code. There is usually a small cost associated with translating operations into byte code, but this is a worthwhile price to pay since the operations then can be executed much faster from Spark. In general, you can ignore this block and focus on the operations that it contains.
</dd>
<dt><code>InMemoryTableScan</code></dt>
<dd>This means that the original dataset <code>data</code> was stored in memory and traversed row by row once.
</dd>
<dt><code>Exchange</code></dt>
<dd>Partitions were exchanged—that is, shuffled—across executors in your cluster.
</dd>
<dt><code>Sort</code></dt>
<dd>Once the records arrived at the right executor, they were sorted in this final stage.
</dd>
</dl>
<div class="figure" style="text-align: center"><span id="fig:tuning-graph-sql-render"></span>
<img src="images/tuning-spark-graph-visualization-sql.png" alt="Spark graph for a sorting query" width="1427" />
<p class="caption">
FIGURE 9.2: Spark graph for a sorting query
</p>
</div>
<p>From<!--((("DAG Visualization")))--> the query details, you then can open the last Spark job to arrive to the job details page, which you can expand by using “DAG Visualization” to create a graph similar to Figure <a href="tuning.html#fig:tuning-graph-render">9.3</a>. This graph shows a few additional details and the stages in this job. Notice that there are no arrows pointing back to previous steps, since Spark makes use of acyclic graphs.</p>
<div class="figure" style="text-align: center"><span id="fig:tuning-graph-render"></span>
<img src="images/tuning-spark-graph-visualization-resized.png" alt="Spark graph for a sorting job" width="1500" />
<p class="caption">
FIGURE 9.3: Spark graph for a sorting job
</p>
</div>
<p>Next, we dive into a Spark stage and explore its event timeline.</p>
</div>
<div id="tuning-event-timeline" class="section level3">
<h3><span class="header-section-number">9.1.2</span> Timeline</h3>
<p>The <em>event timeline</em> is<!--((("event timeline")))((("timeline")))--> a great summary of how Spark is spending computation cycles over each stage. Ideally, you want to see this timeline consisting of mostly CPU usage since other tasks can be considered overhead. You also want to see Spark using all the CPUs across all the cluster nodes available to you.</p>
<p>Select the first stage in the current job and expand the event timeline, which should look similar to Figure <a href="tuning.html#fig:tuning-timeline-simple">9.4</a>. Notice that we explicitly requested three partitions, which are represented by three lanes in this visualization.</p>
<div class="figure" style="text-align: center"><span id="fig:tuning-timeline-simple"></span>
<img src="images/tuning-spark-event-timeline.png" alt="Spark event timeline" width="1410" />
<p class="caption">
FIGURE 9.4: Spark event timeline
</p>
</div>
<p>Since our machine is equipped with four CPUs, we can(((“parallel execution”))) parallelize this computation even further by explicitly repartitioning data using <code>sdf_repartition()</code>, with the result shown in Figure <a href="tuning.html#fig:tuning-timeline-repartition">9.5</a>:</p>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb299-1" title="1">data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sdf_repartition</span>(<span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(id) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collect</span>()</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:tuning-timeline-repartition"></span>
<img src="images/tuning-spark-event-timeline-repartition.png" alt="Spark event timeline with additional partitions" width="1413" />
<p class="caption">
FIGURE 9.5: Spark event timeline with additional partitions
</p>
</div>
<p>Figure <a href="tuning.html#fig:tuning-timeline-repartition">9.5</a> now shows four execution lanes with most time spent under Executor Computing Time, which shows us that this particular operation is making better use of our compute resources. When you are working with clusters, requesting more compute nodes from your cluster should shorten computation time. In contrast, for timelines that show significant time spent shuffling, requesting more compute nodes might not shorten time and might actually make everything slower. There is no concrete set of rules to follow to optimize a stage; however, as you gain experience understanding this timeline over multiple operations, you will develop insights as to how to properly optimize Spark operations.<!--((("", startref="Tover09")))--></p>
</div>
</div>
<div id="tuning-configuring" class="section level2">
<h2><span class="header-section-number">9.2</span> Configuring</h2>
<p>When<!--((("configuring", "common resources to configure")))((("tuning", "configuring", id="Tconfig09")))--> tuning a Spark application, the most common resources to configure are memory and cores, specifically:</p>
<dl>
<dt>Memory in driver</dt>
<dd>The amount of memory required in the driver node
</dd>
<dt>Memory per worker</dt>
<dd>The amount of memory required in the worker nodes
</dd>
<dt>Cores per worker</dt>
<dd>The number of CPUs required in the worker nodes
</dd>
<dt>Number of workers</dt>
<dd>The number of workers required for this session
</dd>
</dl>
<p><strong>Note:</strong> It is recommended to request significantly more memory for the driver than the memory available over each worker node. In most cases, you will want to request one core per worker.</p>
<p>In local mode there are no workers, but we can still configure memory and cores to use through the following:</p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb300-1" title="1"><span class="co"># Initialize configuration with defaults</span></a>
<a class="sourceLine" id="cb300-2" title="2">config &lt;-<span class="st"> </span><span class="kw">spark_config</span>()</a>
<a class="sourceLine" id="cb300-3" title="3"></a>
<a class="sourceLine" id="cb300-4" title="4"><span class="co"># Memory</span></a>
<a class="sourceLine" id="cb300-5" title="5">config[<span class="st">&quot;sparklyr.shell.driver-memory&quot;</span>] &lt;-<span class="st"> &quot;2g&quot;</span></a>
<a class="sourceLine" id="cb300-6" title="6"></a>
<a class="sourceLine" id="cb300-7" title="7"><span class="co"># Cores</span></a>
<a class="sourceLine" id="cb300-8" title="8">config[<span class="st">&quot;sparklyr.connect.cores.local&quot;</span>] &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb300-9" title="9"></a>
<a class="sourceLine" id="cb300-10" title="10"><span class="co"># Connect to local cluster with custom configuration</span></a>
<a class="sourceLine" id="cb300-11" title="11">sc &lt;-<span class="st"> </span><span class="kw">spark_connect</span>(<span class="dt">master =</span> <span class="st">&quot;local&quot;</span>, <span class="dt">config =</span> config)</a></code></pre></div>
<p>When<!--((("configuring", "Standalone and Mesos")))((("Mesos")))((("Apache Mesos")))--> using the Spark Standalone and the Mesos cluster managers, all the available memory and cores are assigned by default; therefore, there are no additional configuration changes required, unless you want to restrict resources to allow multiple users to share this cluster. In this case, you can use <code>total-executor-cores</code> to restrict the total executors requested. The <a href="http://bit.ly/307YtM6"><em>Spark Standalone</em></a> and <a href="http://bit.ly/31H4LCT"><em>Spark on Mesos</em></a> guides provide additional information on sharing clusters.</p>
<p>When<!--((("configuring", "YARN")))--> running under YARN Client, you would configure memory and cores as follows:</p>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb301-1" title="1"><span class="co"># Memory in Driver</span></a>
<a class="sourceLine" id="cb301-2" title="2">config[<span class="st">&quot;sparklyr.shell.driver-memory&quot;</span>] &lt;-<span class="st"> &quot;2g&quot;</span></a>
<a class="sourceLine" id="cb301-3" title="3"></a>
<a class="sourceLine" id="cb301-4" title="4"><span class="co"># Memory per Worker</span></a>
<a class="sourceLine" id="cb301-5" title="5">config[<span class="st">&quot;spark.executor.memory&quot;</span>] &lt;-<span class="st"> &quot;2G&quot;</span> </a>
<a class="sourceLine" id="cb301-6" title="6"></a>
<a class="sourceLine" id="cb301-7" title="7"><span class="co"># Cores per Worker</span></a>
<a class="sourceLine" id="cb301-8" title="8">config[<span class="st">&quot;sparklyr.shell.executor-cores&quot;</span>] &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb301-9" title="9"></a>
<a class="sourceLine" id="cb301-10" title="10"><span class="co"># Number of Workers</span></a>
<a class="sourceLine" id="cb301-11" title="11">config[<span class="st">&quot;sparklyr.shell.num-executors&quot;</span>] &lt;-<span class="st"> </span><span class="dv">3</span></a></code></pre></div>
<p>When using YARN in cluster mode you can use <code>sparklyr.shell.driver-cores</code> to configure total cores requested in the driver node. The <a href="http://bit.ly/306WsQx">Spark on YARN</a> guide provides additional configuration settings that can benefit you.</p>
<p>There<!--((("configuring", "types of configuration settings")))--> are a few types of configuration settings:</p>
<dl>
<dt><em>Connect</em></dt>
<dd>These settings are set as parameters to <code>spark_connect()</code>. They are common settings used while connecting.
</dd>
<dt><em>Submit</em></dt>
<dd>These settings are set while <code>sparklyr</code> is being submitted to Spark through <code>spark-submit</code>; some are dependent on the cluster manager being used.
</dd>
<dt><em>Runtime</em></dt>
<dd>These settings configure Spark when the Spark session is created. They are independent of the cluster manager and specific to Spark.
</dd>
<dt><em>sparklyr</em></dt>
<dd>Use these to configure <code>sparklyr</code> behavior. These settings are independent of the cluster manager and particular to R.
</dd>
</dl>
<p>The following subsections present extensive lists of all the available settings. It is not required that you fully understand them all while tuning Spark, but skimming through them could prove useful in the future for troubleshooting issues. If you prefer, you can skip these subsections and use them instead as reference material as needed.</p>
<div id="connect-settings" class="section level3">
<h3><span class="header-section-number">9.2.1</span> Connect Settings</h3>
<p>You<!--((("configuring", "connect settings")))((("commands", "spark_connect()")))--> can use the parameters listed in Table <a href="tuning.html#tab:tuning-connect-table">9.1</a> with <code>spark_connect()</code>. They configure high-level settings that define the connection method, Spark’s installation path, and the version of Spark to use.</p>
<table>
<caption><span id="tab:tuning-connect-table">TABLE 9.1: </span>Parameters used when connecting to Spark</caption>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="left">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">master</td>
<td align="left">Spark cluster url to connect to. Use “local” to connect to a local instance of Spark installed via ‘spark_install()’.</td>
</tr>
<tr class="even">
<td align="left">spark_home</td>
<td align="left">The path to a Spark installation. Defaults to the path provided by the SPARK_HOME environment variable. If SPARK_HOME is defined, it will always be used unless the version parameter is specified to force the use of a locally installed version.</td>
</tr>
<tr class="odd">
<td align="left">method</td>
<td align="left">The method used to connect to Spark. Default connection method is “shell” to connect using spark-submit, use “livy” to perform remote connections using HTTP, “databricks” when using a Databricks cluster or “qubole” when using a Qubole cluster.</td>
</tr>
<tr class="even">
<td align="left">app_name</td>
<td align="left">The application name to be used while running in the Spark cluster.</td>
</tr>
<tr class="odd">
<td align="left">version</td>
<td align="left">The version of Spark to use. Only applicable to “local” Spark connections.</td>
</tr>
<tr class="even">
<td align="left">config</td>
<td align="left">Custom configuration for the generated Spark connection. See spark_config for details.</td>
</tr>
</tbody>
</table>
<p>You can configure additional settings by specifying a list in the <code>config</code> parameter. Let’s now take a look at what those settings can be.</p>
</div>
<div id="submit-settings" class="section level3">
<h3><span class="header-section-number">9.2.2</span> Submit Settings</h3>
<p>Some<!--((("configuring", "submit settings")))((("spark-submit script")))((("sparklyr package", "spark-submit script")))--> settings must be specified when <code>spark-submit</code> (the terminal application that launches Spark) is run. For instance, since <code>spark-submit</code> launches a driver node that runs as a Java instance, how much memory is allocated needs to be specified as a parameter to <code>spark-submit</code>.</p>
<p>You can list all the available <code>spark-submit</code> parameters by running the following:</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb302-1" title="1"><span class="kw">spark_home_dir</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">file.path</span>(<span class="st">&quot;bin&quot;</span>, <span class="st">&quot;spark-submit&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">system2</span>()</a></code></pre></div>
<p>For readability, we’ve provided the output of this command in Table <a href="tuning.html#tab:tuning-submit-table">9.2</a>, replacing the <code>spark-submit</code> parameter with the appropriate <code>spark_config()</code> setting and removing the parameters that are not applicable or already presented in this chapter.</p>
<table>
<caption><span id="tab:tuning-submit-table">TABLE 9.2: </span>Setting available to configure spark-submit</caption>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="left">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sparklyr.shell.jars</td>
<td align="left">Specified as ‘jars’ parameter in ‘spark_connect()’.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.shell.packages</td>
<td align="left">Comma-separated list of maven coordinates of jars to include on the driver and executor classpaths. Will search the local maven repo, then maven central and any additional remote repositories given by ‘sparklyr.shell.repositories’. The format for the coordinates should be groupId:artifactId:version.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.shell.exclude-packages</td>
<td align="left">Comma-separated list of groupId:artifactId, to exclude while resolving the dependencies provided in ‘sparklyr.shell.packages’ to avoid dependency conflicts.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.shell.repositories</td>
<td align="left">Comma-separated list of additional remote repositories to search for the maven coordinates given with ‘sparklyr.shell.packages’</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.shell.files</td>
<td align="left">Comma-separated list of files to be placed in the working directory of each executor. File paths of these files in executors can be accessed via SparkFiles.get(fileName).</td>
</tr>
<tr class="even">
<td align="left">sparklyr.shell.conf</td>
<td align="left">Arbitrary Spark configuration property set as PROP=VALUE.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.shell.properties-file</td>
<td align="left">Path to a file from which to load extra properties. If not specified, this will look for conf/spark-defaults.conf.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.shell.driver-java-options</td>
<td align="left">Extra Java options to pass to the driver.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.shell.driver-library-path</td>
<td align="left">Extra library path entries to pass to the driver.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.shell.driver-class-path</td>
<td align="left">Extra class path entries to pass to the driver. Note that jars added with ‘sparklyr.shell.jars’ are automatically included in the classpath.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.shell.proxy-user</td>
<td align="left">User to impersonate when submitting the application. This argument does not work with ‘sparklyr.shell.principal’ / ‘sparklyr.shell.keytab’.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.shell.verbose</td>
<td align="left">Print additional debug output.</td>
</tr>
</tbody>
</table>
<p>The remaining settings, shown in Table <a href="tuning.html#tab:tuning-yarn-table">9.3</a>, are specific to YARN.</p>
<table>
<caption><span id="tab:tuning-yarn-table">TABLE 9.3: </span>Settings avalable to configure spark-submit when using YARN</caption>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="left">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sparklyr.shell.queue</td>
<td align="left">The YARN queue to submit to (Default: “default”).</td>
</tr>
<tr class="even">
<td align="left">sparklyr.shell.archives</td>
<td align="left">Comma separated list of archives to be extracted into the working directory of each executor.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.shell.principal</td>
<td align="left">Principal to be used to login to KDC, while running on secure HDFS.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.shell.keytab</td>
<td align="left">The full path to the file that contains the keytab for the principal specified above. This keytab will be copied to the node running the Application Master via the Secure Distributed Cache, for renewing the login tickets and the delegation tokens periodically.</td>
</tr>
</tbody>
</table>
<p>In general, any <code>spark-submit</code> setting is configured through <code>sparklyr.shell.X</code>, where X is the name of the <code>spark-submit</code> parameter without the <code>--</code> prefix.</p>
</div>
<div id="runtime-settings" class="section level3">
<h3><span class="header-section-number">9.2.3</span> Runtime Settings</h3>
<p>As<!--((("configuring", "runtime settings")))--> mentioned, some Spark settings configure the session runtime. The runtime settings are a superset of the <a href="tuning.html#submit-settings">submit settings</a> given that it is usually helpful to retrieve the current configuration even if a setting can’t be changed.</p>
<p>To list the Spark settings set in your current Spark session, you can run the following:</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb303-1" title="1"><span class="kw">spark_session_config</span>(sc)</a></code></pre></div>
<p>Table <a href="tuning.html#tab:tuning-runtime-config-table">9.4</a> describes the runtime settings.</p>
<table>
<caption><span id="tab:tuning-runtime-config-table">TABLE 9.4: </span>Setting available to configure the Spark session</caption>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="left">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">spark.master</td>
<td align="left">local[4]</td>
</tr>
<tr class="even">
<td align="left">spark.sql.shuffle.partitions</td>
<td align="left">4</td>
</tr>
<tr class="odd">
<td align="left">spark.driver.port</td>
<td align="left">62314</td>
</tr>
<tr class="even">
<td align="left">spark.submit.deployMode</td>
<td align="left">client</td>
</tr>
<tr class="odd">
<td align="left">spark.executor.id</td>
<td align="left">driver</td>
</tr>
<tr class="even">
<td align="left">spark.jars</td>
<td align="left">/Library/…/sparklyr/java/sparklyr-2.3-2.11.jar</td>
</tr>
<tr class="odd">
<td align="left">spark.app.id</td>
<td align="left">local-1545518234395</td>
</tr>
<tr class="even">
<td align="left">spark.env.SPARK_LOCAL_IP</td>
<td align="left">127.0.0.1</td>
</tr>
<tr class="odd">
<td align="left">spark.sql.catalogImplementation</td>
<td align="left">hive</td>
</tr>
<tr class="even">
<td align="left">spark.spark.port.maxRetries</td>
<td align="left">128</td>
</tr>
<tr class="odd">
<td align="left">spark.app.name</td>
<td align="left">sparklyr</td>
</tr>
<tr class="even">
<td align="left">spark.home</td>
<td align="left">/Users/…/spark/spark-2.3.2-bin-hadoop2.7</td>
</tr>
<tr class="odd">
<td align="left">spark.driver.host</td>
<td align="left">localhost</td>
</tr>
</tbody>
</table>
<p>However, there are many more configuration settings available in Spark, as described in the <a href="http://bit.ly/2P0Yalf"><em>Spark Configuration</em></a> guide. It’s beyond the scope of this book to describe them all, so, if possible, take some time to identify the ones that might be of interest to your particular use cases.</p>
</div>
<div id="sparklyr-settings" class="section level3">
<h3><span class="header-section-number">9.2.4</span> sparklyr Settings</h3>
<p>Apart<!--((("configuring", "sparklyr settings", id="Csparklyr09")))((("commands", "spark_config_settings()")))((("sparklyr package", "configuration settings", id="SPconfig09")))--> from Spark settings, there are a few settings particular to <code>sparklyr</code>. You usually don’t use these settings while tuning Spark; instead, they are helpful while troubleshooting Spark from R. For instance, you can use <code>sparklyr.log.console = TRUE</code> to output the Spark logs into the R console; this is ideal while troubleshooting but too noisy otherwise. Here’s how to list the settings (results are presented in Table <a href="tuning.html#tab:tuning-settings-sparklyr-code">9.5</a>):</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb304-1" title="1"><span class="kw">spark_config_settings</span>()</a></code></pre></div>
<table>
<caption><span id="tab:tuning-settings-sparklyr-code">TABLE 9.5: </span>Settings available to configure the sparklyr package</caption>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sparklyr.apply.packages</td>
<td align="left">Configures default value for packages parameter in spark_apply().</td>
</tr>
<tr class="even">
<td align="left">sparklyr.apply.rlang</td>
<td align="left">Experimental feature. Turns on improved serialization for spark_apply().</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.apply.serializer</td>
<td align="left">Configures the version spark_apply() uses to serialize the closure.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.apply.schema.infer</td>
<td align="left">Number of rows collected to infer schema when column types specified in spark_apply().</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.arrow</td>
<td align="left">Use Apache Arrow to serialize data?</td>
</tr>
<tr class="even">
<td align="left">sparklyr.backend.interval</td>
<td align="left">Total seconds sparklyr will check on a backend operation.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.backend.timeout</td>
<td align="left">Total seconds before sparklyr will give up waiting for a backend operation to complete.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.collect.batch</td>
<td align="left">Total rows to collect when using batch collection, defaults to 100,000.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.cancellable</td>
<td align="left">Cancel spark jobs when the R session is interrupted?</td>
</tr>
<tr class="even">
<td align="left">sparklyr.connect.aftersubmit</td>
<td align="left">R function to call after spark-submit executes.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.connect.app.jar</td>
<td align="left">The path to the sparklyr jar used in spark_connect().</td>
</tr>
<tr class="even">
<td align="left">sparklyr.connect.cores.local</td>
<td align="left">Number of cores to use in spark_connect(master = “local”), defaults to parallel::detectCores().</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.connect.csv.embedded</td>
<td align="left">Regular expression to match against versions of Spark that require package extension to support CSVs.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.connect.csv.scala11</td>
<td align="left">Use Scala 2.11 jars when using embedded CSV jars in Spark 1.6.X.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.connect.jars</td>
<td align="left">Additional JARs to include while submitting application to Spark.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.connect.master</td>
<td align="left">The cluster master as spark_connect() master parameter, notice that the ‘spark.master’ setting is usually preferred.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.connect.packages</td>
<td align="left">Spark packages to include when connecting to Spark.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.connect.ondisconnect</td>
<td align="left">R function to call after spark_disconnect().</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.connect.sparksubmit</td>
<td align="left">Command executed instead of spark-submit when connecting.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.connect.timeout</td>
<td align="left">Total seconds before giving up connecting to the sparklyr gateway while initializing.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.dplyr.period.splits</td>
<td align="left">Should ‘dplyr’ split column names into database and table?</td>
</tr>
<tr class="even">
<td align="left">sparklyr.extensions.catalog</td>
<td align="left">Catalog PATH where extension JARs are located. Defaults to ‘TRUE’, ‘FALSE’ to disable.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.gateway.address</td>
<td align="left">The address of the driver machine.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.gateway.config.retries</td>
<td align="left">Number of retries to retrieve port and address from config, useful when using functions to query port or address in kubernetes.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.gateway.interval</td>
<td align="left">Total of seconds sparkyr will check on a gateway connection.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.gateway.port</td>
<td align="left">The port the sparklyr gateway uses in the driver machine, defaults to 8880.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.gateway.remote</td>
<td align="left">Should the sparklyr gateway allow remote connections? This is required in yarn cluster, etc.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.gateway.routing</td>
<td align="left">Should the sparklyr gateway service route to other sessions? Consider disabling in kubernetes.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.gateway.service</td>
<td align="left">Should the sparklyr gateway be run as a service without shutting down when the last connection disconnects?</td>
</tr>
<tr class="even">
<td align="left">sparklyr.gateway.timeout</td>
<td align="left">Total seconds before giving up connecting to the sparklyr gateway after initialization.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.gateway.wait</td>
<td align="left">Total seconds to wait before retrying to contact the sparklyr gateway.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.livy.auth</td>
<td align="left">Authentication method for Livy connections.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.livy.headers</td>
<td align="left">Additional HTTP headers for Livy connections.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.livy.sources</td>
<td align="left">Should sparklyr sources be sourced when connecting? If false, manually register sparklyr jars.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.log.invoke</td>
<td align="left">Should every call to invoke() be printed in the console? Can be set to ‘callstack’ to log call stack.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.log.console</td>
<td align="left">Should driver logs be printed in the console?</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.progress</td>
<td align="left">Should job progress be reported to RStudio?</td>
</tr>
<tr class="even">
<td align="left">sparklyr.progress.interval</td>
<td align="left">Total of seconds to wait before attempting to retrieve job progress in Spark.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.sanitize.column.names</td>
<td align="left">Should partially unsupported column names be cleaned up?</td>
</tr>
<tr class="even">
<td align="left">sparklyr.stream.collect.timeout</td>
<td align="left">Total seconds before stopping collecting a stream sample in sdf_collect_stream().</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.stream.validate.timeout</td>
<td align="left">Total seconds before stopping to check if stream has errors while being created.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.verbose</td>
<td align="left">Use verbose logging across all sparklyr operations?</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.verbose.na</td>
<td align="left">Use verbose logging when dealing with NAs?</td>
</tr>
<tr class="even">
<td align="left">sparklyr.verbose.sanitize</td>
<td align="left">Use verbose logging while sanitizing columns and other objects?</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.web.spark</td>
<td align="left">The URL to Spark’s web interface.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.web.yarn</td>
<td align="left">The URL to YARN’s web interface.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.worker.gateway.address</td>
<td align="left">The address of the worker machine, most likely localhost.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.worker.gateway.port</td>
<td align="left">The port the sparklyr gateway uses in the driver machine.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.yarn.cluster.accepted.timeout</td>
<td align="left">Total seconds before giving up waiting for cluster resources in yarn cluster mode.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.yarn.cluster.hostaddress.timeout</td>
<td align="left">Total seconds before giving up waiting for the cluster to assign a host address in yarn cluster mode.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.yarn.cluster.lookup.byname</td>
<td align="left">Should the current user name be used to filter yarn cluster jobs while searching for submitted one?</td>
</tr>
<tr class="even">
<td align="left">sparklyr.yarn.cluster.lookup.prefix</td>
<td align="left">Application name prefix used to filter yarn cluster jobs while searching for submitted one.</td>
</tr>
<tr class="odd">
<td align="left">sparklyr.yarn.cluster.lookup.username</td>
<td align="left">The user name used to filter yarn cluster jobs while searching for submitted one.</td>
</tr>
<tr class="even">
<td align="left">sparklyr.yarn.cluster.start.timeout</td>
<td align="left">Total seconds before giving up waiting for yarn cluster application to get registered.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="tuning-partitioning" class="section level2">
<h2><span class="header-section-number">9.3</span> Partitioning</h2>
<p>As<!--((("", startref="SPconfig09")))((("", startref="Csparklyr09")))((("", startref="Tconfig09")))((("tuning", "partitioning")))--> mentioned in <a href="intro.html#intro">Chapter 1</a>, MapReduce and Spark were designed with the purpose of performing computations against data stored across many machines. The subset of the data available for computation over each compute instance is known as a <em>partition</em>.</p>
<p>By default, Spark computes over each existing <em>implicit</em> partition since it’s more effective to run computations where the data is already located. However, there are cases for which you will want to set an <em>explicit</em> partition to help Spark make more efficient use of your cluster resources.</p>
<div id="implicit-partitions" class="section level3">
<h3><span class="header-section-number">9.3.1</span> Implicit Partitions</h3>
<p>As <a href="data.html#data">Chapter 8</a> explained, Spark<!--((("partitioning", "implicit partitions")))((("implicit partitions")))--> can read data stored in many formats and different storage systems; however, since shuffling data is an expensive operation, Spark executes tasks reusing the partitions in the storage system. Therefore, these partitions are implicit to Spark since they are already well defined and expensive to rearrange.</p>
<p>There is always an implicit partition for every computation in Spark defined by the distributed storage system, even for operations which you wouldn’t expect that create partitions, like <code>copy_to()</code>.</p>
<p>You can explore the number of partitions a computation will require by using <code>sdf_num_partitions()</code>:</p>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb305-1" title="1"><span class="kw">sdf_len</span>(sc, <span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sdf_num_partitions</span>()</a></code></pre></div>
<pre><code>[1] 2</code></pre>
<p>While in most cases the default partitions work just fine, there are cases for which you will need to be explicit about the partitions you choose.</p>
</div>
<div id="explicit-partitions" class="section level3">
<h3><span class="header-section-number">9.3.2</span> Explicit Partitions</h3>
<p>There<!--((("partitioning", "explicit partitions")))((("explicit partitions")))--> will be times when you have many more or far fewer compute instances than data partitions. In both cases, it<!--((("repartitioning")))--> can help to <em>repartition</em> data to match your cluster resources.</p>
<p>Various <a href="data.html#data">data</a> functions, like <code>spark_read_csv()</code>, already support a <code>repartition</code> parameter to request that Spark repartition data appropriately. For instance, we can create a sequence of 10 numbers partitioned by 10 as follows:</p>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb307-1" title="1"><span class="kw">sdf_len</span>(sc, <span class="dv">10</span>, <span class="dt">repartition =</span> <span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sdf_num_partitions</span>()</a></code></pre></div>
<pre><code>[1] 10</code></pre>
<p>For datasets that are already partitioned, we can also use <code>sdf_repartition()</code>:</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb309-1" title="1"><span class="kw">sdf_len</span>(sc, <span class="dv">10</span>, <span class="dt">repartition =</span> <span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb309-2" title="2"><span class="st">  </span><span class="kw">sdf_repartition</span>(<span class="dv">4</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb309-3" title="3"><span class="st">  </span><span class="kw">sdf_num_partitions</span>()</a></code></pre></div>
<pre><code>[1] 4</code></pre>
<p>The number of partitions usually significantly changes the speed and resources being used; for instance, the following example calculates the mean over 10 million rows with different partition sizes:</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb311-1" title="1"><span class="kw">library</span>(microbenchmark)</a>
<a class="sourceLine" id="cb311-2" title="2"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb311-3" title="3"></a>
<a class="sourceLine" id="cb311-4" title="4"><span class="kw">microbenchmark</span>(</a>
<a class="sourceLine" id="cb311-5" title="5">    <span class="st">&quot;1 Partition(s)&quot;</span> =<span class="st"> </span><span class="kw">sdf_len</span>(sc, <span class="dv">10</span><span class="op">^</span><span class="dv">7</span>, <span class="dt">repartition =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb311-6" title="6"><span class="st">      </span><span class="kw">summarise</span>(<span class="kw">mean</span>(id)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collect</span>(),</a>
<a class="sourceLine" id="cb311-7" title="7">    <span class="st">&quot;2 Partition(s)&quot;</span> =<span class="st"> </span><span class="kw">sdf_len</span>(sc, <span class="dv">10</span><span class="op">^</span><span class="dv">7</span>, <span class="dt">repartition =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb311-8" title="8"><span class="st">      </span><span class="kw">summarise</span>(<span class="kw">mean</span>(id)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collect</span>(),</a>
<a class="sourceLine" id="cb311-9" title="9">    <span class="dt">times =</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb311-10" title="10">) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">autoplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme_light</span>() </a></code></pre></div>
<p>Figure <a href="tuning.html#fig:tuning-partitioning-explicit-results">9.6</a> shows that sorting data with two partitions is almost twice as fast. This is because two CPUs can be used to execute this operation. However, it is not necessarily the case that higher partitions produce faster computation; instead, partitioning data is particular to your computing cluster and the data analysis operations being performed.</p>
<div class="figure" style="text-align: center"><span id="fig:tuning-partitioning-explicit-results"></span>
<img src="images/tuning-partition-explicit.png" alt="Computation speed with additional explicit partitions" width="1500" />
<p class="caption">
FIGURE 9.6: Computation speed with additional explicit partitions
</p>
</div>
</div>
</div>
<div id="tuning-caching" class="section level2">
<h2><span class="header-section-number">9.4</span> Caching</h2>
<p>Recall<!--((("tuning", "caching")))((("caching", "benefits of")))((("resilient distributed dataset (RDD)")))--> from <a href="intro.html#intro">Chapter 1</a> that Spark was designed to be faster than its predecessors by using memory instead of disk to store data. This is formally known as a Spark <em>resilient distributed dataset</em> (RDD). An RDD distributes copies of the same data across many machines, such that if one machine fails, others can complete the task—hence, the term “resilient.” Resiliency is important in distributed systems since, while things will usually work in one machine, when running over thousands of machines the likelihood of something failing is much higher. When a failure happens, it is preferable to be fault tolerant to avoid losing the work of all the other machines. RDDs accomplish this by tracking data lineage information to rebuild lost data automatically on failure.</p>
<p>In <code>sparklyr</code>, you<!--((("commands", "tbl_cache()")))((("commands", "tbl_uncache()")))--> can control when an RDD is loaded or unloaded from memory using <code>tbl_cache()</code> and <code>tbl_uncache()</code>.</p>
<p>Most <code>sparklyr</code> operations that retrieve a<!--((("DataFrames", "retrieving")))--> Spark DataFrame cache the results in memory. For instance, running <code>spark_read_parquet()</code> or <code>copy_to()</code> will provide a Spark DataFrame that is already cached in memory. As a Spark DataFrame, this object can be used in most <code>sparklyr</code> functions, including data analysis with <code>dplyr</code> or machine learning:</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb312-1" title="1"><span class="kw">library</span>(sparklyr)</a>
<a class="sourceLine" id="cb312-2" title="2">sc &lt;-<span class="st"> </span><span class="kw">spark_connect</span>(<span class="dt">master =</span> <span class="st">&quot;local&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb313-1" title="1">iris_tbl &lt;-<span class="st"> </span><span class="kw">copy_to</span>(sc, iris, <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>You can inspect which tables are cached by navigating to the Spark UI using <code>spark_web(sc)</code>, clicking the Storage tab, and then clicking on a specific RDD, as illustrated in Figure <a href="tuning.html#fig:tuning-caching-rdd-shot">9.7</a>.</p>
<div class="figure" style="text-align: center"><span id="fig:tuning-caching-rdd-shot"></span>
<img src="images/tuning-cache-rdd-web-resized.png" alt="Cached RDD in the Spark web interface" width="1500" />
<p class="caption">
FIGURE 9.7: Cached RDD in the Spark web interface
</p>
</div>
<p>Data loaded in memory will be released when the R session terminates, either explicitly or implicitly, with a restart or disconnection; however, to free up resources, you can use <code>tbl_uncache()</code>:</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb314-1" title="1"><span class="kw">tbl_uncache</span>(sc, <span class="st">&quot;iris&quot;</span>)</a></code></pre></div>
<div id="checkpointing" class="section level3">
<h3><span class="header-section-number">9.4.1</span> Checkpointing</h3>
<p>Checkpointing<!--((("checkpointing")))((("caching", "checkpointing")))--> is a slightly different type of caching; while it also saves data, it will additionally break the graph computation lineage. For example, if a cached partition is lost, it can be computed from the computation graph, which is not possible with checkpointing since the source of computation is lost.</p>
<p>When performing operations which create expensive computation graphs, it can make sense to checkpoint to save and break the computation lineage in order to help Spark reduce graph computation resources; otherwise, Spark might try to optimize a computation graph that is really not useful to optimize.</p>
<p>You<!--((("commands", "sdf_checkpoint()")))--> can checkpoint explicitly by saving to CSV, Parquet, and other file formats. Or, let Spark checkpoint this for you by using <code>sdf_checkpoint()</code> in <code>sparklyr</code>, as follows:</p>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb315-1" title="1"><span class="co"># set checkpoint path</span></a>
<a class="sourceLine" id="cb315-2" title="2"><span class="kw">spark_set_checkpoint_dir</span>(sc, <span class="kw">getwd</span>())</a>
<a class="sourceLine" id="cb315-3" title="3"></a>
<a class="sourceLine" id="cb315-4" title="4"><span class="co"># checkpoint the iris dataset</span></a>
<a class="sourceLine" id="cb315-5" title="5">iris_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sdf_checkpoint</span>()</a></code></pre></div>
<p>Notice that checkpointing truncates the computation lineage graph, which can speed up performance if the same intermediate result is used multiple times.</p>
</div>
<div id="tuning-memory" class="section level3">
<h3><span class="header-section-number">9.4.2</span> Memory</h3>
<p>Memory<!--((("caching", "memory")))((("memory")))((("Apache Spark", "memory categories in")))--> in Spark is categorized into <em>reserved</em>, <em>user</em>, <em>execution</em>, or <em>storage</em>:</p>
<dl>
<dt>Reserved</dt>
<dd>Reserved memory is the memory Spark needs to function and therefore is overhead that is required and should not be configured. This value defaults to 300 MB.
</dd>
<dt>User</dt>
<dd>User memory is the memory used to execute custom code. <code>sparklyr</code> makes use of this memory only indirectly when executing <code>dplyr</code> expressions or modeling a dataset.
</dd>
<dt>Execution</dt>
<dd>Execution memory is used to execute code by Spark, mostly to process the results from the partition and perform shuffling.
</dd>
<dt>Storage</dt>
<dd>Storage memory is used to cache RDDs—for instance, when using <code>compute()</code> in <code>sparklyr</code>.
</dd>
</dl>
<p>As part of tuning execution, you can consider tweaking the amount of memory allocated for user, execution, and storage by creating a Spark connection with different values than the defaults provided in Spark:</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb316-1" title="1">config &lt;-<span class="st"> </span><span class="kw">spark_config</span>()</a>
<a class="sourceLine" id="cb316-2" title="2"></a>
<a class="sourceLine" id="cb316-3" title="3"><span class="co"># define memory available for storage and execution</span></a>
<a class="sourceLine" id="cb316-4" title="4">config<span class="op">$</span>spark.memory.fraction &lt;-<span class="st"> </span><span class="fl">0.75</span></a>
<a class="sourceLine" id="cb316-5" title="5"></a>
<a class="sourceLine" id="cb316-6" title="6"><span class="co"># define memory available for storage</span></a>
<a class="sourceLine" id="cb316-7" title="7">config<span class="op">$</span>spark.memory.storageFraction &lt;-<span class="st"> </span><span class="fl">0.5</span></a></code></pre></div>
<p>For instance, if you want to use Spark to store large amounts of data in memory with the purpose of quickly filtering and retrieving subsets, you can expect Spark to use little execution or user memory. Therefore, to maximize storage memory, you can tune Spark as follows:</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb317-1" title="1">config &lt;-<span class="st"> </span><span class="kw">spark_config</span>()</a>
<a class="sourceLine" id="cb317-2" title="2"></a>
<a class="sourceLine" id="cb317-3" title="3"><span class="co"># define memory available for storage and execution</span></a>
<a class="sourceLine" id="cb317-4" title="4">config<span class="op">$</span>spark.memory.fraction &lt;-<span class="st"> </span><span class="fl">0.90</span></a>
<a class="sourceLine" id="cb317-5" title="5"></a>
<a class="sourceLine" id="cb317-6" title="6"><span class="co"># define memory available for storage</span></a>
<a class="sourceLine" id="cb317-7" title="7">config<span class="op">$</span>spark.memory.storageFraction &lt;-<span class="st"> </span><span class="fl">0.90</span></a></code></pre></div>
<p>However, note that Spark will borrow execution memory from storage and vice versa if needed and if possible; therefore, in practice, there should be little need to tune the memory settings.</p>
</div>
</div>
<div id="tuning-shuffling" class="section level2">
<h2><span class="header-section-number">9.5</span> Shuffling</h2>
<p>Shuffling is<!--((("tuning", "shuffling")))((("shuffling")))((("event timeline")))((("timeline")))--> the operation that redistributes data across machines; it is usually expensive and therefore something you should try to minimize. You can easily identify whether significant time is being spent shuffling by looking at the <a href="tuning.html#tuning-event-timeline">event timeline</a>. It is possible to reduce shuffling by reframing data analysis questions or hinting Spark appropriately.</p>
<p>This<!--((("DataFrames", "joining frames that differ in size")))--> would be relevant, for instance, when joining DataFrames that differ in size significantly; that is, one set is orders of magnitude smaller than the other one. You can consider using <code>sdf_broadcast()</code> to mark a DataFrame as small enough for use in broadcast joins, meaning it pushes one of the smaller DataFrames to each of the worker nodes to reduce shuffling the bigger DataFrame. Here’s one example for <code>sdf_broadcast()</code>:</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb318-1" title="1"><span class="kw">sdf_len</span>(sc, <span class="dv">10000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb318-2" title="2"><span class="st">    </span><span class="kw">sdf_broadcast</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb318-3" title="3"><span class="st">    </span><span class="kw">left_join</span>(<span class="kw">sdf_len</span>(sc, <span class="dv">100</span>))</a></code></pre></div>
</div>
<div id="tuning-serialization" class="section level2">
<h2><span class="header-section-number">9.6</span> Serialization</h2>
<p>Serialization<!--((("tuning", "serialization")))((("serialization", "tuning")))--> is the process of translating data and tasks into a format that can be transmitted between machines and reconstructed on the receiving end.</p>
<p>It is not that common to need to adjust serialization when tuning Spark; however, it is worth mentioning that there are alternative serialization modules like the <a href="https://oreil.ly/TRbNh">Kryo Serializer</a> that can provide performance improvements over the default <a href="https://oreil.ly/0DMsd">Java Serializer</a>.</p>
<p>You can turn on the Kryo Serializer in <code>sparklyr</code> through the following:</p>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb319-1" title="1">config &lt;-<span class="st"> </span><span class="kw">spark_config</span>()</a>
<a class="sourceLine" id="cb319-2" title="2"></a>
<a class="sourceLine" id="cb319-3" title="3">config<span class="op">$</span>spark.serializer &lt;-<span class="st"> &quot;org.apache.spark.serializer.KryoSerializer&quot;</span></a>
<a class="sourceLine" id="cb319-4" title="4">sc &lt;-<span class="st"> </span><span class="kw">spark_connect</span>(<span class="dt">master =</span> <span class="st">&quot;local&quot;</span>, <span class="dt">config =</span> config)</a></code></pre></div>
</div>
<div id="configuration-files" class="section level2">
<h2><span class="header-section-number">9.7</span> Configuration Files</h2>
<p>Configuring<!--((("configuration files")))((("tuning", "configuration files")))--> the <code>spark_config()</code> settings before connecting is the most common approach while tuning Spark. However, after you identify the parameters in your connection, you should consider switching to use a configuration file since it will remove the clutter in your connection code and also allow you to share the configuration settings across projects and coworkers.</p>
<p>For instance, instead of connecting to Spark like this:</p>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb320-1" title="1">config &lt;-<span class="st"> </span><span class="kw">spark_config</span>()</a>
<a class="sourceLine" id="cb320-2" title="2">config[<span class="st">&quot;sparklyr.shell.driver-memory&quot;</span>] &lt;-<span class="st"> &quot;2G&quot;</span></a>
<a class="sourceLine" id="cb320-3" title="3">sc &lt;-<span class="st"> </span><span class="kw">spark_connect</span>(<span class="dt">master =</span> <span class="st">&quot;local&quot;</span>, <span class="dt">config =</span> config)</a></code></pre></div>
<p>you can define a <em>config.yml</em> file with the desired settings. This file should be located in the current working directory or in parent directories. For example, you can create the following <em>config.yml</em> file to modify the default driver memory:</p>
<div class="sourceCode" id="cb321"><pre class="sourceCode yml"><code class="sourceCode yaml"><a class="sourceLine" id="cb321-1" title="1"><span class="fu">default:</span></a>
<a class="sourceLine" id="cb321-2" title="2">  <span class="fu">sparklyr.shell.driver-memory:</span><span class="at"> 2G</span></a></code></pre></div>
<p>Then, connecting with the same configuration settings becomes much cleaner by using instead:</p>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb322-1" title="1">sc &lt;-<span class="st"> </span><span class="kw">spark_connect</span>(<span class="dt">master =</span> <span class="st">&quot;local&quot;</span>)</a></code></pre></div>
<p>You can also specify an alternate configuration filename or location by setting the <code>file</code> parameter in <code>spark_config()</code>. One additional benefit from using configuration files is that a system administrator can change the default configuration by changing the value of the <code>R_CONFIG_ACTIVE</code> environment variable. See the GitHub <a href="https://oreil.ly/74jIL">rstudio/config</a> repo for additional information.</p>
</div>
<div id="recap-6" class="section level2">
<h2><span class="header-section-number">9.8</span> Recap</h2>
<p>This chapter provided a broad overview of Spark internals and detailed configuration settings to help you speed up computation and enable high computation loads. It provided the foundations to understand bottlenecks and guidance on common configuration considerations. However, fine-tuning Spark is a broad topic that would require many more chapters to cover extensively. Therefore, while troubleshooting Spark’s performance and scalability, searching the web, and consulting online communities, it is often necessary to fine-tune your particular environment as well.</p>
<p><a href="extensions.html#extensions">Chapter 10</a> introduces the ecosystem of Spark extensions that are available in R. Most extensions are highly specialized, but they will prove to be extremely useful in specific cases and for readers with particular needs. For instance, they can process nested data, perform graph analysis, and use different modeling libraries like <code>rsparkling</code> from H20. In addition, the next few chapters introduce many advanced data analysis and modeling topics that are required to master large-scale computing in R.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="extensions.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
