<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>The R in Spark: Learning Apache Spark with R</title>
  <meta name="description" content="A book to learn Apache Spark with R using the sparklyr R package.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="The R in Spark: Learning Apache Spark with R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A book to learn Apache Spark with R using the sparklyr R package." />
  <meta name="github-repo" content="javierluraschi/the-r-in-spark" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="The R in Spark: Learning Apache Spark with R" />
  
  <meta name="twitter:description" content="A book to learn Apache Spark with R using the sparklyr R package." />
  



<meta name="date" content="2018-11-17">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="distributed.html">
<link rel="next" href="contributing.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-1.3/htmlwidgets.js"></script>
<script src="libs/r2d3-render-0.1.0/r2d3-render.js"></script>
<script src="libs/webcomponents-2.0.0/webcomponents.js"></script>
<script src="libs/r2d3-binding-0.2.2/r2d3.js"></script>
<script src="libs/d3v5-5.0.0/d3.min.js"></script>
<script src="libs/dagre-0.0.1/dagre.min.js"></script>
<script src="libs/lodash-3.7.0/lodash.js"></script>
<script src="libs/nomnoml-0.2.0/nomnoml.js"></script>
<script src="libs/nomnoml-binding-0.1.0/nomnoml.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-119986300-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-119986300-1');
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><strong><a href="./">Learning Apache Spark with R</a></strong></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#structure"><i class="fa fa-check"></i>Structure</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#authors"><i class="fa fa-check"></i>Authors</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#acknowledgments"><i class="fa fa-check"></i>Acknowledgments</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#intro-background"><i class="fa fa-check"></i><b>1.1</b> Background</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#spark"><i class="fa fa-check"></i><b>1.2</b> Spark</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#r"><i class="fa fa-check"></i><b>1.3</b> R</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#sparklyr"><i class="fa fa-check"></i><b>1.4</b> sparklyr</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="starting.html"><a href="starting.html"><i class="fa fa-check"></i><b>2</b> Getting Started</a><ul>
<li class="chapter" data-level="2.1" data-path="starting.html"><a href="starting.html#prerequisites"><i class="fa fa-check"></i><b>2.1</b> Prerequisites</a><ul>
<li class="chapter" data-level="2.1.1" data-path="starting.html"><a href="starting.html#install-r"><i class="fa fa-check"></i><b>2.1.1</b> Install R</a></li>
<li class="chapter" data-level="2.1.2" data-path="starting.html"><a href="starting.html#install-java"><i class="fa fa-check"></i><b>2.1.2</b> Install Java</a></li>
<li class="chapter" data-level="2.1.3" data-path="starting.html"><a href="starting.html#install-rstudio"><i class="fa fa-check"></i><b>2.1.3</b> Install RStudio</a></li>
<li class="chapter" data-level="2.1.4" data-path="starting.html"><a href="starting.html#install-sparklyr"><i class="fa fa-check"></i><b>2.1.4</b> Install sparklyr</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="starting.html"><a href="starting.html#installing-spark"><i class="fa fa-check"></i><b>2.2</b> Installing Spark</a></li>
<li class="chapter" data-level="2.3" data-path="starting.html"><a href="starting.html#connecting-to-spark"><i class="fa fa-check"></i><b>2.3</b> Connecting to Spark</a></li>
<li class="chapter" data-level="2.4" data-path="starting.html"><a href="starting.html#sparklyr-hello-world"><i class="fa fa-check"></i><b>2.4</b> Using Spark</a><ul>
<li class="chapter" data-level="2.4.1" data-path="starting.html"><a href="starting.html#spark-web-interface"><i class="fa fa-check"></i><b>2.4.1</b> Web Interface</a></li>
<li class="chapter" data-level="2.4.2" data-path="starting.html"><a href="starting.html#logs"><i class="fa fa-check"></i><b>2.4.2</b> Logs</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="starting.html"><a href="starting.html#disconnecting"><i class="fa fa-check"></i><b>2.5</b> Disconnecting</a></li>
<li class="chapter" data-level="2.6" data-path="starting.html"><a href="starting.html#using-spark-from-rstudio"><i class="fa fa-check"></i><b>2.6</b> RStudio</a></li>
<li class="chapter" data-level="2.7" data-path="starting.html"><a href="starting.html#recap"><i class="fa fa-check"></i><b>2.7</b> Recap</a></li>
</ul></li>
<li class="part"><span><b>I Analysis</b></span></li>
<li class="chapter" data-level="3" data-path="analysis.html"><a href="analysis.html"><i class="fa fa-check"></i><b>3</b> Analysis</a><ul>
<li class="chapter" data-level="3.1" data-path="analysis.html"><a href="analysis.html#overview"><i class="fa fa-check"></i><b>3.1</b> Overview</a></li>
<li class="chapter" data-level="3.2" data-path="analysis.html"><a href="analysis.html#dplyr"><i class="fa fa-check"></i><b>3.2</b> dplyr</a><ul>
<li class="chapter" data-level="3.2.1" data-path="analysis.html"><a href="analysis.html#pass-through-functions"><i class="fa fa-check"></i><b>3.2.1</b> Pass-through Functions</a></li>
<li class="chapter" data-level="3.2.2" data-path="analysis.html"><a href="analysis.html#dplyr-reosurces"><i class="fa fa-check"></i><b>3.2.2</b> Resources</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="analysis.html"><a href="analysis.html#dbi"><i class="fa fa-check"></i><b>3.3</b> DBI</a></li>
</ul></li>
<li class="part"><span><b>II Modeling</b></span></li>
<li class="chapter" data-level="4" data-path="modeling.html"><a href="modeling.html"><i class="fa fa-check"></i><b>4</b> Modeling</a><ul>
<li class="chapter" data-level="4.1" data-path="modeling.html"><a href="modeling.html#overview-1"><i class="fa fa-check"></i><b>4.1</b> Overview</a></li>
<li class="chapter" data-level="4.2" data-path="modeling.html"><a href="modeling.html#supervised"><i class="fa fa-check"></i><b>4.2</b> Supervised</a></li>
<li class="chapter" data-level="4.3" data-path="modeling.html"><a href="modeling.html#unsupervised"><i class="fa fa-check"></i><b>4.3</b> Unsupervised</a><ul>
<li class="chapter" data-level="4.3.1" data-path="modeling.html"><a href="modeling.html#k-means-clustering"><i class="fa fa-check"></i><b>4.3.1</b> K-Means Clustering</a></li>
<li class="chapter" data-level="4.3.2" data-path="modeling.html"><a href="modeling.html#gaussian-mixture-clustering"><i class="fa fa-check"></i><b>4.3.2</b> Gaussian Mixture Clustering</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="modeling.html"><a href="modeling.html#broom"><i class="fa fa-check"></i><b>4.4</b> Broom</a></li>
<li class="chapter" data-level="4.5" data-path="modeling.html"><a href="modeling.html#pipelines"><i class="fa fa-check"></i><b>4.5</b> Pipelines</a></li>
</ul></li>
<li class="part"><span><b>III Scaling</b></span></li>
<li class="chapter" data-level="5" data-path="clusters.html"><a href="clusters.html"><i class="fa fa-check"></i><b>5</b> Clusters</a><ul>
<li class="chapter" data-level="5.1" data-path="clusters.html"><a href="clusters.html#overview-2"><i class="fa fa-check"></i><b>5.1</b> Overview</a></li>
<li class="chapter" data-level="5.2" data-path="clusters.html"><a href="clusters.html#managers"><i class="fa fa-check"></i><b>5.2</b> Managers</a><ul>
<li class="chapter" data-level="5.2.1" data-path="clusters.html"><a href="clusters.html#clusters-standalone"><i class="fa fa-check"></i><b>5.2.1</b> Standalone</a></li>
<li class="chapter" data-level="5.2.2" data-path="clusters.html"><a href="clusters.html#yarn"><i class="fa fa-check"></i><b>5.2.2</b> Yarn</a></li>
<li class="chapter" data-level="5.2.3" data-path="clusters.html"><a href="clusters.html#mesos"><i class="fa fa-check"></i><b>5.2.3</b> Mesos</a></li>
<li class="chapter" data-level="5.2.4" data-path="clusters.html"><a href="clusters.html#kubernetes"><i class="fa fa-check"></i><b>5.2.4</b> Kubernetes</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="clusters.html"><a href="clusters.html#on-premise"><i class="fa fa-check"></i><b>5.3</b> On-Premise</a><ul>
<li class="chapter" data-level="5.3.1" data-path="clusters.html"><a href="clusters.html#cloudera"><i class="fa fa-check"></i><b>5.3.1</b> Cloudera</a></li>
<li class="chapter" data-level="5.3.2" data-path="clusters.html"><a href="clusters.html#hortonworks"><i class="fa fa-check"></i><b>5.3.2</b> Hortonworks</a></li>
<li class="chapter" data-level="5.3.3" data-path="clusters.html"><a href="clusters.html#mapr"><i class="fa fa-check"></i><b>5.3.3</b> MapR</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="clusters.html"><a href="clusters.html#cloud"><i class="fa fa-check"></i><b>5.4</b> Cloud</a><ul>
<li class="chapter" data-level="5.4.1" data-path="clusters.html"><a href="clusters.html#amazon"><i class="fa fa-check"></i><b>5.4.1</b> Amazon</a></li>
<li class="chapter" data-level="5.4.2" data-path="clusters.html"><a href="clusters.html#google"><i class="fa fa-check"></i><b>5.4.2</b> Google</a></li>
<li class="chapter" data-level="5.4.3" data-path="clusters.html"><a href="clusters.html#microsoft"><i class="fa fa-check"></i><b>5.4.3</b> Microsoft</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="clusters.html"><a href="clusters.html#tools"><i class="fa fa-check"></i><b>5.5</b> Tools</a><ul>
<li class="chapter" data-level="5.5.1" data-path="clusters.html"><a href="clusters.html#rstudio"><i class="fa fa-check"></i><b>5.5.1</b> RStudio</a></li>
<li class="chapter" data-level="5.5.2" data-path="clusters.html"><a href="clusters.html#jupyter"><i class="fa fa-check"></i><b>5.5.2</b> Jupyter</a></li>
<li class="chapter" data-level="5.5.3" data-path="clusters.html"><a href="clusters.html#clusters-livy"><i class="fa fa-check"></i><b>5.5.3</b> Livy</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="clusters.html"><a href="clusters.html#recap-1"><i class="fa fa-check"></i><b>5.6</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="connections.html"><a href="connections.html"><i class="fa fa-check"></i><b>6</b> Connections</a><ul>
<li class="chapter" data-level="6.1" data-path="connections.html"><a href="connections.html#overview-3"><i class="fa fa-check"></i><b>6.1</b> Overview</a><ul>
<li class="chapter" data-level="6.1.1" data-path="connections.html"><a href="connections.html#edge-nodes"><i class="fa fa-check"></i><b>6.1.1</b> Edge Nodes</a></li>
<li class="chapter" data-level="6.1.2" data-path="connections.html"><a href="connections.html#spark-home"><i class="fa fa-check"></i><b>6.1.2</b> Spark Home</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="connections.html"><a href="connections.html#types"><i class="fa fa-check"></i><b>6.2</b> Types</a><ul>
<li class="chapter" data-level="6.2.1" data-path="connections.html"><a href="connections.html#connection-local"><i class="fa fa-check"></i><b>6.2.1</b> Local</a></li>
<li class="chapter" data-level="6.2.2" data-path="connections.html"><a href="connections.html#standalone"><i class="fa fa-check"></i><b>6.2.2</b> Standalone</a></li>
<li class="chapter" data-level="6.2.3" data-path="connections.html"><a href="connections.html#yarn-1"><i class="fa fa-check"></i><b>6.2.3</b> Yarn</a></li>
<li class="chapter" data-level="6.2.4" data-path="connections.html"><a href="connections.html#livy"><i class="fa fa-check"></i><b>6.2.4</b> Livy</a></li>
<li class="chapter" data-level="6.2.5" data-path="connections.html"><a href="connections.html#mesos-1"><i class="fa fa-check"></i><b>6.2.5</b> Mesos</a></li>
<li class="chapter" data-level="6.2.6" data-path="connections.html"><a href="connections.html#kubernetes-1"><i class="fa fa-check"></i><b>6.2.6</b> Kubernetes</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="connections.html"><a href="connections.html#troubleshooting"><i class="fa fa-check"></i><b>6.3</b> Troubleshooting</a><ul>
<li class="chapter" data-level="6.3.1" data-path="connections.html"><a href="connections.html#logging"><i class="fa fa-check"></i><b>6.3.1</b> Logging</a></li>
<li class="chapter" data-level="6.3.2" data-path="connections.html"><a href="connections.html#troubleshoot-spark-submit"><i class="fa fa-check"></i><b>6.3.2</b> Spark Submit</a></li>
<li class="chapter" data-level="6.3.3" data-path="connections.html"><a href="connections.html#multiple"><i class="fa fa-check"></i><b>6.3.3</b> Multiple</a></li>
<li class="chapter" data-level="6.3.4" data-path="connections.html"><a href="connections.html#windows"><i class="fa fa-check"></i><b>6.3.4</b> Windows</a></li>
<li class="chapter" data-level="6.3.5" data-path="connections.html"><a href="connections.html#submit-manually"><i class="fa fa-check"></i><b>6.3.5</b> Submit Manually</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="connections.html"><a href="connections.html#recap-2"><i class="fa fa-check"></i><b>6.4</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>7</b> Data</a><ul>
<li class="chapter" data-level="7.1" data-path="data.html"><a href="data.html#overview-4"><i class="fa fa-check"></i><b>7.1</b> Overview</a></li>
<li class="chapter" data-level="7.2" data-path="data.html"><a href="data.html#dataframes"><i class="fa fa-check"></i><b>7.2</b> DataFrames</a><ul>
<li class="chapter" data-level="7.2.1" data-path="data.html"><a href="data.html#data-sdf-functions"><i class="fa fa-check"></i><b>7.2.1</b> Functions</a></li>
<li class="chapter" data-level="7.2.2" data-path="data.html"><a href="data.html#pivoting"><i class="fa fa-check"></i><b>7.2.2</b> Pivoting</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="data.html"><a href="data.html#formats"><i class="fa fa-check"></i><b>7.3</b> Formats</a></li>
<li class="chapter" data-level="7.4" data-path="data.html"><a href="data.html#data-types"><i class="fa fa-check"></i><b>7.4</b> Data Types</a><ul>
<li class="chapter" data-level="7.4.1" data-path="data.html"><a href="data.html#dates"><i class="fa fa-check"></i><b>7.4.1</b> Dates</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="data.html"><a href="data.html#external"><i class="fa fa-check"></i><b>7.5</b> External</a><ul>
<li class="chapter" data-level="7.5.1" data-path="data.html"><a href="data.html#amazon-s3"><i class="fa fa-check"></i><b>7.5.1</b> Amazon S3</a></li>
<li class="chapter" data-level="7.5.2" data-path="data.html"><a href="data.html#azure-storage"><i class="fa fa-check"></i><b>7.5.2</b> Azure Storage</a></li>
<li class="chapter" data-level="7.5.3" data-path="data.html"><a href="data.html#cassandra"><i class="fa fa-check"></i><b>7.5.3</b> Cassandra</a></li>
<li class="chapter" data-level="7.5.4" data-path="data.html"><a href="data.html#databases"><i class="fa fa-check"></i><b>7.5.4</b> Databases</a></li>
<li class="chapter" data-level="7.5.5" data-path="data.html"><a href="data.html#hbase"><i class="fa fa-check"></i><b>7.5.5</b> HBase</a></li>
<li class="chapter" data-level="7.5.6" data-path="data.html"><a href="data.html#nested-data"><i class="fa fa-check"></i><b>7.5.6</b> Nested Data</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="data.html"><a href="data.html#troubleshooting-1"><i class="fa fa-check"></i><b>7.6</b> Troubleshooting</a><ul>
<li class="chapter" data-level="7.6.1" data-path="data.html"><a href="data.html#troubleshoot-csvs"><i class="fa fa-check"></i><b>7.6.1</b> Troubleshoot CSVs</a></li>
<li class="chapter" data-level="7.6.2" data-path="data.html"><a href="data.html#column-names"><i class="fa fa-check"></i><b>7.6.2</b> Column Names</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="data.html"><a href="data.html#recap-3"><i class="fa fa-check"></i><b>7.7</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="tuning.html"><a href="tuning.html"><i class="fa fa-check"></i><b>8</b> Tuning</a><ul>
<li class="chapter" data-level="8.1" data-path="tuning.html"><a href="tuning.html#overview-5"><i class="fa fa-check"></i><b>8.1</b> Overview</a><ul>
<li class="chapter" data-level="8.1.1" data-path="tuning.html"><a href="tuning.html#tunning-graph-vusualization"><i class="fa fa-check"></i><b>8.1.1</b> Graph Visualization</a></li>
<li class="chapter" data-level="8.1.2" data-path="tuning.html"><a href="tuning.html#tunning-event-timeline"><i class="fa fa-check"></i><b>8.1.2</b> Event Timeline</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="tuning.html"><a href="tuning.html#tunning-configuring"><i class="fa fa-check"></i><b>8.2</b> Configuring</a><ul>
<li class="chapter" data-level="8.2.1" data-path="tuning.html"><a href="tuning.html#submit-settings"><i class="fa fa-check"></i><b>8.2.1</b> Submit Settings</a></li>
<li class="chapter" data-level="8.2.2" data-path="tuning.html"><a href="tuning.html#runtime-settings"><i class="fa fa-check"></i><b>8.2.2</b> Runtime Settings</a></li>
<li class="chapter" data-level="8.2.3" data-path="tuning.html"><a href="tuning.html#sparklyr-settings"><i class="fa fa-check"></i><b>8.2.3</b> Sparklyr Settings</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="tuning.html"><a href="tuning.html#tunning-partitioning"><i class="fa fa-check"></i><b>8.3</b> Partitioning</a><ul>
<li class="chapter" data-level="8.3.1" data-path="tuning.html"><a href="tuning.html#implicit"><i class="fa fa-check"></i><b>8.3.1</b> Implicit</a></li>
<li class="chapter" data-level="8.3.2" data-path="tuning.html"><a href="tuning.html#explicit"><i class="fa fa-check"></i><b>8.3.2</b> Explicit</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="tuning.html"><a href="tuning.html#tunning-caching"><i class="fa fa-check"></i><b>8.4</b> Caching</a><ul>
<li class="chapter" data-level="8.4.1" data-path="tuning.html"><a href="tuning.html#checkpointing"><i class="fa fa-check"></i><b>8.4.1</b> Checkpointing</a></li>
<li class="chapter" data-level="8.4.2" data-path="tuning.html"><a href="tuning.html#tunning-memory"><i class="fa fa-check"></i><b>8.4.2</b> Memory</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="tuning.html"><a href="tuning.html#tunning-shuffling"><i class="fa fa-check"></i><b>8.5</b> Shuffling</a></li>
<li class="chapter" data-level="8.6" data-path="tuning.html"><a href="tuning.html#tunning-serialization"><i class="fa fa-check"></i><b>8.6</b> Serialization</a></li>
<li class="chapter" data-level="8.7" data-path="tuning.html"><a href="tuning.html#recap-4"><i class="fa fa-check"></i><b>8.7</b> Recap</a></li>
</ul></li>
<li class="part"><span><b>IV Extensions</b></span></li>
<li class="chapter" data-level="9" data-path="extensions.html"><a href="extensions.html"><i class="fa fa-check"></i><b>9</b> Extensions</a><ul>
<li class="chapter" data-level="9.1" data-path="extensions.html"><a href="extensions.html#rsparkling"><i class="fa fa-check"></i><b>9.1</b> RSparkling</a><ul>
<li class="chapter" data-level="9.1.1" data-path="extensions.html"><a href="extensions.html#trpoubleshooting"><i class="fa fa-check"></i><b>9.1.1</b> Trpoubleshooting</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="extensions.html"><a href="extensions.html#graphframes"><i class="fa fa-check"></i><b>9.2</b> GraphFrames</a></li>
<li class="chapter" data-level="9.3" data-path="extensions.html"><a href="extensions.html#mleap"><i class="fa fa-check"></i><b>9.3</b> Mleap</a></li>
<li class="chapter" data-level="9.4" data-path="extensions.html"><a href="extensions.html#extensions-nested-data"><i class="fa fa-check"></i><b>9.4</b> Nested Data</a></li>
</ul></li>
<li class="part"><span><b>V Advanced</b></span></li>
<li class="chapter" data-level="10" data-path="distributed.html"><a href="distributed.html"><i class="fa fa-check"></i><b>10</b> Distributed R</a><ul>
<li class="chapter" data-level="10.1" data-path="distributed.html"><a href="distributed.html#use-cases"><i class="fa fa-check"></i><b>10.1</b> Use Cases</a><ul>
<li class="chapter" data-level="10.1.1" data-path="distributed.html"><a href="distributed.html#embarrassingly-parallel"><i class="fa fa-check"></i><b>10.1.1</b> Embarrassingly Parallel</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="distributed.html"><a href="distributed.html#columns"><i class="fa fa-check"></i><b>10.2</b> Columns</a><ul>
<li class="chapter" data-level="10.2.1" data-path="distributed.html"><a href="distributed.html#inference"><i class="fa fa-check"></i><b>10.2.1</b> Inference</a></li>
<li class="chapter" data-level="10.2.2" data-path="distributed.html"><a href="distributed.html#excplicit"><i class="fa fa-check"></i><b>10.2.2</b> Excplicit</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="distributed.html"><a href="distributed.html#grouping"><i class="fa fa-check"></i><b>10.3</b> Grouping</a></li>
<li class="chapter" data-level="10.4" data-path="distributed.html"><a href="distributed.html#packages"><i class="fa fa-check"></i><b>10.4</b> Packages</a></li>
<li class="chapter" data-level="10.5" data-path="distributed.html"><a href="distributed.html#restrictions"><i class="fa fa-check"></i><b>10.5</b> Restrictions</a></li>
<li class="chapter" data-level="10.6" data-path="distributed.html"><a href="distributed.html#troubleshooting-2"><i class="fa fa-check"></i><b>10.6</b> Troubleshooting</a><ul>
<li class="chapter" data-level="10.6.1" data-path="distributed.html"><a href="distributed.html#tips"><i class="fa fa-check"></i><b>10.6.1</b> Tips</a></li>
<li class="chapter" data-level="10.6.2" data-path="distributed.html"><a href="distributed.html#logs-1"><i class="fa fa-check"></i><b>10.6.2</b> Logs</a></li>
<li class="chapter" data-level="10.6.3" data-path="distributed.html"><a href="distributed.html#debugging"><i class="fa fa-check"></i><b>10.6.3</b> Debugging</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="streaming.html"><a href="streaming.html"><i class="fa fa-check"></i><b>11</b> Streaming</a><ul>
<li class="chapter" data-level="11.1" data-path="streaming.html"><a href="streaming.html#overview-6"><i class="fa fa-check"></i><b>11.1</b> Overview</a></li>
<li class="chapter" data-level="11.2" data-path="streaming.html"><a href="streaming.html#transformations"><i class="fa fa-check"></i><b>11.2</b> Transformations</a><ul>
<li class="chapter" data-level="11.2.1" data-path="streaming.html"><a href="streaming.html#streams-dplyr"><i class="fa fa-check"></i><b>11.2.1</b> dplyr</a></li>
<li class="chapter" data-level="11.2.2" data-path="streaming.html"><a href="streaming.html#streams-pipelines"><i class="fa fa-check"></i><b>11.2.2</b> Pipelines</a></li>
<li class="chapter" data-level="11.2.3" data-path="streaming.html"><a href="streaming.html#streams-r"><i class="fa fa-check"></i><b>11.2.3</b> R Code</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="streaming.html"><a href="streaming.html#shiny"><i class="fa fa-check"></i><b>11.3</b> Shiny</a></li>
<li class="chapter" data-level="11.4" data-path="streaming.html"><a href="streaming.html#formats-1"><i class="fa fa-check"></i><b>11.4</b> Formats</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="contributing.html"><a href="contributing.html"><i class="fa fa-check"></i><b>12</b> Contributing</a><ul>
<li class="chapter" data-level="12.1" data-path="contributing.html"><a href="contributing.html#overview-7"><i class="fa fa-check"></i><b>12.1</b> Overview</a></li>
<li class="chapter" data-level="12.2" data-path="contributing.html"><a href="contributing.html#r-extension"><i class="fa fa-check"></i><b>12.2</b> R Extensions</a></li>
<li class="chapter" data-level="12.3" data-path="contributing.html"><a href="contributing.html#scala-extensions"><i class="fa fa-check"></i><b>12.3</b> Scala Extensions</a><ul>
<li class="chapter" data-level="12.3.1" data-path="contributing.html"><a href="contributing.html#scala-extension-prereq"><i class="fa fa-check"></i><b>12.3.1</b> Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="contributing.html"><a href="contributing.html#spark-extensions"><i class="fa fa-check"></i><b>12.4</b> Spark Extensions</a></li>
<li class="chapter" data-level="12.5" data-path="contributing.html"><a href="contributing.html#r-packages"><i class="fa fa-check"></i><b>12.5</b> R Packages</a><ul>
<li class="chapter" data-level="12.5.1" data-path="contributing.html"><a href="contributing.html#rstudio-projects"><i class="fa fa-check"></i><b>12.5.1</b> RStudio Projects</a></li>
<li class="chapter" data-level="12.5.2" data-path="contributing.html"><a href="contributing.html#troubleshooting-3"><i class="fa fa-check"></i><b>12.5.2</b> Troubleshooting</a></li>
</ul></li>
<li class="chapter" data-level="12.6" data-path="contributing.html"><a href="contributing.html#contributing-sparklyr"><i class="fa fa-check"></i><b>12.6</b> sparklyr</a><ul>
<li class="chapter" data-level="12.6.1" data-path="contributing.html"><a href="contributing.html#compiling"><i class="fa fa-check"></i><b>12.6.1</b> Compiling</a></li>
<li class="chapter" data-level="12.6.2" data-path="contributing.html"><a href="contributing.html#serialization"><i class="fa fa-check"></i><b>12.6.2</b> Serialization</a></li>
<li class="chapter" data-level="12.6.3" data-path="contributing.html"><a href="contributing.html#invocations"><i class="fa fa-check"></i><b>12.6.3</b> Invocations</a></li>
<li class="chapter" data-level="12.6.4" data-path="contributing.html"><a href="contributing.html#r-packages-1"><i class="fa fa-check"></i><b>12.6.4</b> R Packages</a></li>
<li class="chapter" data-level="12.6.5" data-path="contributing.html"><a href="contributing.html#connections-1"><i class="fa fa-check"></i><b>12.6.5</b> Connections</a></li>
<li class="chapter" data-level="12.6.6" data-path="contributing.html"><a href="contributing.html#distributed-r"><i class="fa fa-check"></i><b>12.6.6</b> Distributed R</a></li>
</ul></li>
<li class="chapter" data-level="12.7" data-path="contributing.html"><a href="contributing.html#recap-5"><i class="fa fa-check"></i><b>12.7</b> Recap</a></li>
</ul></li>
<li class="part"><span><b>VI Appendix</b></span></li>
<li class="chapter" data-level="13" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>13</b> Appendix</a><ul>
<li class="chapter" data-level="13.1" data-path="appendix.html"><a href="appendix.html#diagrams"><i class="fa fa-check"></i><b>13.1</b> Diagrams</a><ul>
<li class="chapter" data-level="13.1.1" data-path="appendix.html"><a href="appendix.html#storage-capacity"><i class="fa fa-check"></i><b>13.1.1</b> Worlds Store Capacity</a></li>
<li class="chapter" data-level="13.1.2" data-path="appendix.html"><a href="appendix.html#cran-downloads"><i class="fa fa-check"></i><b>13.1.2</b> Daily downloads of CRAN packages</a></li>
<li class="chapter" data-level="13.1.3" data-path="appendix.html"><a href="appendix.html#cluster-trends"><i class="fa fa-check"></i><b>13.1.3</b> Google trends for mainframes, cloud computing and kubernetes</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>14</b> References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The R in Spark: Learning Apache Spark with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="streaming" class="section level1">
<h1><span class="header-section-number">Chapter 11</span> Streaming</h1>
<div id="overview-6" class="section level2">
<h2><span class="header-section-number">11.1</span> Overview</h2>
<p>One can understand a stream as an unbounded data frame, meaning, a data frame with finite columns but infinite rows. Streams are most relevant when processing real time data; for example, when analyzing a Twitter feed or stock prices. Both examples have well defined columns, like ‘tweet’ or ‘price’, but there are always new rows of data to be analyzed.</p>
<p>Spark provided initial support for streams with Spark’s DStreams; however, a more versatile and efficient replacement is available through <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html">Spark structured streams</a>. Structured streams provide scalable and fault-torerant data processing over streams of data. That means, one can use many machines to process multiple streaming sources, perform joins with other streams or static sources, and recover from failures with at-least-once guarantees (where each message is certain to be delivered, but may do so multiple times).</p>
<p>In order to use structured streams in <code>sparklyr</code>, one needs to define the <strong>sources</strong>, <strong>transformations</strong> and a <strong>destination</strong>:</p>
<ul>
<li>The <strong>sources</strong> are defined using any of the <code>stream_read_*()</code> functions to read streams of data from various data sources.</li>
<li>The <strong>transformations</strong> can be specified using <code>dplyr</code>, <code>SQL</code>, scoring pipelines or R code through <code>spark_apply()</code>.</li>
<li>The <strong>destination</strong> is defined with the <code>stream_write_*()</code> functions, it often also referenced as a sink.</li>
</ul>
<p>Since the transformation step is optional, the simplest stream we can define is to continuously process files, which would effectively copy text files between source and destination. We can define this copy-stream in <code>sparklyr</code> as follows:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb122-1" data-line-number="1"><span class="kw">library</span>(sparklyr)</a>
<a class="sourceLine" id="cb122-2" data-line-number="2">sc &lt;-<span class="st"> </span><span class="kw">spark_connect</span>(<span class="dt">master =</span> <span class="st">&quot;local&quot;</span>)</a></code></pre></div>
<pre><code>## /Users/javierluraschi/spark/spark-2.3.2-bin-hadoop2.7/bin/spark-submit --class sparklyr.Shell &#39;/Library/Frameworks/R.framework/Versions/3.5/Resources/library/sparklyr/java/sparklyr-2.3-2.11.jar&#39; 8880 33441</code></pre>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb124-1" data-line-number="1">stream &lt;-<span class="st"> </span><span class="kw">stream_read_text</span>(sc, <span class="st">&quot;source/&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">stream_write_text</span>(<span class="st">&quot;destination/&quot;</span>)</a></code></pre></div>
<p>The streams starts running with <code>stream_write_*()</code>; once executed, the stream will monitor the <code>source</code> path and process data into the <code>destination/</code> path as it arrives. We can use <code>view_stream()</code> to track the <strong>rows per second (rps)</strong> being processed in the source, destination and their latest values over time:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb125-1" data-line-number="1"><span class="kw">stream_view</span>(stream)</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-141"></span>
<div id="htmlwidget-6cd328d80f580a6aa6e8" style="width:100%;height:280pt;" class="r2d3 html-widget"></div>
<script type="application/json" data-for="htmlwidget-6cd328d80f580a6aa6e8">{"x":{"data":{"sources":["FileStreamSource[file:source]"],"sinks":["FileSink[destination/]"],"stats":[{"timestamp":"2018-07-11T00:36:48.974Z","rps":{"in":0,"out":0}},{"timestamp":"2018-07-11T00:36:48.974Z","rps":{"in":0,"out":0}},{"timestamp":"2018-07-11T00:36:54.004Z","rps":{"in":9,"out":8}},{"timestamp":"2018-07-11T00:36:56.001Z","rps":{"in":15,"out":52}},{"timestamp":"2018-07-11T00:36:57.003Z","rps":{"in":22,"out":112}},{"timestamp":"2018-07-11T00:36:58.004Z","rps":{"in":64,"out":317}},{"timestamp":"2018-07-11T00:36:59.004Z","rps":{"in":187,"out":711}},{"timestamp":"2018-07-11T00:37:00.004Z","rps":{"in":487,"out":2352}},{"timestamp":"2018-07-11T00:37:01.004Z","rps":{"in":1108,"out":5485}},{"timestamp":"2018-07-11T00:37:02.003Z","rps":{"in":2209,"out":8723}},{"timestamp":"2018-07-11T00:37:03.001Z","rps":{"in":3878,"out":19068}},{"timestamp":"2018-07-11T00:37:04.000Z","rps":{"in":6034,"out":30912}},{"timestamp":"2018-07-11T00:37:05.004Z","rps":{"in":8358,"out":37464}},{"timestamp":"2018-07-11T00:37:06.002Z","rps":{"in":10532,"out":49347}},{"timestamp":"2018-07-11T00:37:07.000Z","rps":{"in":11927,"out":63657}},{"timestamp":"2018-07-11T00:37:08.001Z","rps":{"in":12231,"out":66183}},{"timestamp":"2018-07-11T00:37:09.001Z","rps":{"in":11932,"out":59593}},{"timestamp":"2018-07-11T00:37:10.001Z","rps":{"in":11480,"out":53395}},{"timestamp":"2018-07-11T00:37:11.001Z","rps":{"in":9841,"out":52908}},{"timestamp":"2018-07-11T00:37:12.003Z","rps":{"in":7718,"out":42032}},{"timestamp":"2018-07-11T00:37:13.000Z","rps":{"in":5601,"out":29240}},{"timestamp":"2018-07-11T00:37:14.005Z","rps":{"in":3695,"out":18117}},{"timestamp":"2018-07-11T00:37:15.005Z","rps":{"in":2280,"out":11752}},{"timestamp":"2018-07-11T00:37:16.004Z","rps":{"in":1300,"out":7021}},{"timestamp":"2018-07-11T00:37:17.004Z","rps":{"in":700,"out":3846}},{"timestamp":"2018-07-11T00:37:18.002Z","rps":{"in":391,"out":2102}},{"timestamp":"2018-07-11T00:37:19.004Z","rps":{"in":296,"out":1485}},{"timestamp":"2018-07-11T00:37:20.004Z","rps":{"in":391,"out":2068}},{"timestamp":"2018-07-11T00:37:21.000Z","rps":{"in":702,"out":3910}},{"timestamp":"2018-07-11T00:37:22.005Z","rps":{"in":1292,"out":7098}},{"timestamp":"2018-07-11T00:37:24.003Z","rps":{"in":3721,"out":19343}},{"timestamp":"2018-07-11T00:37:25.004Z","rps":{"in":5579,"out":30519}},{"timestamp":"2018-07-11T00:37:26.004Z","rps":{"in":7734,"out":41580}},{"timestamp":"2018-07-11T00:37:27.004Z","rps":{"in":9841,"out":49205}},{"timestamp":"2018-07-11T00:37:28.003Z","rps":{"in":11491,"out":62391}},{"timestamp":"2018-07-11T00:37:29.004Z","rps":{"in":12231,"out":68402}},{"timestamp":"2018-07-11T00:37:30.002Z","rps":{"in":11927,"out":66502}},{"timestamp":"2018-07-11T00:37:31.004Z","rps":{"in":10490,"out":55321}},{"timestamp":"2018-07-11T00:37:32.005Z","rps":{"in":8383,"out":46364}},{"timestamp":"2018-07-11T00:37:33.004Z","rps":{"in":6034,"out":25221}},{"timestamp":"2018-07-11T00:37:34.005Z","rps":{"in":3867,"out":19750}},{"timestamp":"2018-07-11T00:37:35.002Z","rps":{"in":2213,"out":9808}},{"timestamp":"2018-07-11T00:37:36.005Z","rps":{"in":1104,"out":3807}},{"timestamp":"2018-07-11T00:37:37.002Z","rps":{"in":488,"out":2352}},{"timestamp":"2018-07-11T00:37:38.002Z","rps":{"in":187,"out":882}},{"timestamp":"2018-07-11T00:37:39.005Z","rps":{"in":64,"out":357}},{"timestamp":"2018-07-11T00:37:40.000Z","rps":{"in":32,"out":221}},{"timestamp":"2018-07-11T00:37:41.004Z","rps":{"in":22,"out":131}},{"timestamp":"2018-07-11T00:37:42.002Z","rps":{"in":12,"out":69}},{"timestamp":"2018-07-11T00:37:43.003Z","rps":{"in":9,"out":56}},{"timestamp":"2018-07-11T00:37:44.001Z","rps":{"in":10,"out":55}}]},"type":"list","container":"div","options":["function (...) ",".Internal(options(...))"],"script":"var d3Script = function(d3, r2d3, data, div, width, height, options, theme, console) {\nthis.d3 = d3;\n\ndiv = d3.select(div.node());\n/* R2D3 Source File:  /Library/Frameworks/R.framework/Versions/3.5/Resources/library/sparklyr/streams/stream.js */\n// !preview r2d3 data=list(sources = list(\"FileStreamSource[file]\"), sinks = list(\"FileSink[file]\"), stats = list(list(rps = list(\"in\" = 3, out = 2)), list(rps = list(\"in\" = 5, out = 10)), list(rps = list(\"in\" = 10, out = 10)), list(rps = list(\"in\" = 10, out = 10)), list(rps = list(\"in\" = 10, out = 10)), list(rps = list(\"in\" = 10, out = 10)), list(rps = list(\"in\" = 10, out = 10)), list(rps = list(\"in\" = 10, out = 10)), list(rps = list(\"in\" = 10, out = 10)), list(rps = list(\"in\" = 10, out = 10)))), options = list(demo = FALSE), container = \"div\"\n\nfunction StreamStats() {\n  var rpmIn = [0];\n  var rpmOut = [0];\n\n  var maxIn = 10;\n  var maxOut = 10;\n\n  var maxStats = 100;\n\n  this.add = function(rps) {\n    if (maxIn < rps.in) maxIn = rps.in;\n    if (maxOut < rps.out) maxOut = rps.out;\n\n    rpmIn.unshift(rps.in);\n    rpmOut.unshift(rps.out);\n\n    rpmIn = rpmIn.slice(0, Math.min(rpmIn.length, maxStats - 1));\n    rpmOut = rpmOut.slice(0, Math.min(rpmOut.length, maxStats - 1));\n  };\n\n  this.rpmIn = function() {\n    return rpmIn;\n  };\n\n  this.rpmOut = function() {\n    return rpmOut;\n  };\n\n  this.maxIn = function() {\n    return maxIn;\n  };\n\n  this.maxOut = function() {\n    return maxOut;\n  };\n\n  this.latestRpsIn = function() {\n    return rpmIn[0];\n  };\n\n  this.latestRpsOut = function() {\n    return rpmOut[0];\n  };\n\n  this.count = function() {\n    return rpmIn.length;\n  };\n}\n\nvar stats = new StreamStats();\n\nfunction StreamRenderer(stats) {\n  var self = this;\n  var width = 0;\n  var height = 0;\n\n  div.attr(\"class\", \"root\");\n  var svg = div.append(\"svg\");\n  var chart = div.append(\"svg\")\n    .attr(\"class\", \"chart\");\n\n  chart.append(\"marker\")\n    .attr(\"id\", \"circle\")\n    .attr(\"markerWidth\", \"4\").attr(\"markerHeight\", \"4\")\n    .attr(\"refX\", \"2\").attr(\"refY\", \"2\")\n    .append(\"circle\")\n      .attr(\"cx\", \"2\").attr(\"cy\", \"2\").attr(\"r\", \"2\")\n      .attr(\"class\", \"tick\");\n\n  var ticks = chart.append(\"g\");\n\n  var chartIn;\n  var chartOut;\n  var rowsPerSecondIn;\n  var rowsPerSecondOut;\n\n  var barWidth = 10;\n  var margin = 30;\n  var marginLeft = margin + 10;\n  var remotesCircle = 10;\n  var remotesMargin = margin;\n  var remotesHeight = 0;\n  var chartHeight = 0;\n  var barsHeight = 0;\n  var annotationHeight = 20;\n  var stopped = false;\n\n  this.formatRps = function(num) {\n    return d3.format(\",.0f\")(num);\n  };\n\n  this.setSize = function(newWidth, newHeight) {\n    remotesHeight = Math.min(40, newHeight / 3);\n    chartHeight = newHeight - 2 * remotesHeight - 2 * margin;\n    barsHeight = chartHeight - 2 * annotationHeight;\n\n    svg.attr(\"width\", newWidth).attr(\"height\", newHeight);\n\n    chart.attr(\"width\", newWidth).attr(\"height\", chartHeight);\n    chart.style(\"margin-top\", margin + remotesHeight + \"px\");\n\n    chart.style(\"display\", newHeight < 120 ? \"none\" : \"block\");\n\n    width = newWidth;\n    height =  newHeight;\n  };\n\n  this.stop = function() {\n    stopped = true;\n  };\n\n  this.stopped = function() {\n    return stopped;\n  };\n\n  this.annotate = function(x, text) {\n    ticks.append(\"line\")\n      .attr(\"class\", \"horizon\")\n      .attr(\"x1\", x)\n      .attr(\"y1\", 10)\n      .attr(\"x2\", x)\n      .attr(\"y2\", chartHeight / 2)\n      .attr(\"marker-start\", \"url(#circle)\")\n      .attr(\"marker-end\", \"url(#circle)\");\n\n    ticks.append(\"text\")\n      .attr(\"y\", 13).attr(\"x\", x + 4)\n      .attr(\"class\", \"annotation\")\n      .text(text);\n  };\n\n  var animateClass = \"animate\";\n  this.setAnimateClass = function(name) {\n    animateClass = name;\n  };\n\n  this.update = function() {\n    chart.attr(\"class\", \"chart\");\n    if (!stopped) {\n      setTimeout(function() {\n        chart.attr(\"class\", \"chart \" + self.animateClass);\n      }, 50);\n    }\n    else {\n      chart.attr(\"class\", \"chart stop\");\n    }\n\n    rowsPerSecondIn.text(self.formatRps(stats.latestRpsIn()) + \" rps\");\n    rowsPerSecondOut.text(self.formatRps(stats.latestRpsOut()) + \" rps\");\n\n    rowsPerSecondIn.style(\"display\", height < 60 ? \"none\" : \"block\");\n    rowsPerSecondOut.style(\"display\", height < 60 ? \"none\" : \"block\");\n\n    var dataIn = chartIn.selectAll(\"rect\")\n      .data(stats.rpmIn());\n\n    var barsIn = dataIn\n      .enter()\n        .append(\"rect\")\n      .merge(dataIn)\n        .attr(\"width\", barWidth - 2)\n        .attr(\"height\", function(d, i) { return barsHeight / 2 * d / stats.maxIn();})\n        .attr(\"x\", function(d, i) { return marginLeft + i * barWidth - barWidth; })\n        .attr(\"y\", function(d, i) { return chartHeight / 2 - barsHeight / 2 * d / stats.maxIn(); })\n        .attr(\"class\", \"barIn\")\n        .on(\"mouseover\", function (d, i) {\n          rowsPerSecondIn.text(self.formatRps(d) + \" rps\");\n          d3.select(this.parentNode).selectAll(\"rect\").attr(\"class\", \"barIn\");\n          d3.select(this).attr(\"class\", \"barIn selected\");\n        });\n\n    var dataOut = chartOut.selectAll(\"rect\")\n      .data(stats.rpmOut());\n\n    var barsOut = dataOut.\n      enter()\n        .append(\"rect\")\n      .merge(dataOut)\n        .attr(\"width\", barWidth - 2)\n        .attr(\"height\", function(d, i) { return barsHeight / 2 * d / stats.maxOut();})\n        .attr(\"x\", function(d, i) { return marginLeft + i * barWidth - barWidth; })\n        .attr(\"y\", function(d, i) { return chartHeight / 2; })\n        .attr(\"class\", \"barOut\")\n        .on(\"mouseover\", function (d, i) {\n          rowsPerSecondOut.text(self.formatRps(d) + \" rps\");\n          d3.select(this.parentNode).selectAll(\"rect\").attr(\"class\", \"barOut\");\n          d3.select(this).attr(\"class\", \"barOut selected\");\n        });\n\n    ticks.selectAll(\"*\").remove();\n    ticks.append(\"line\")\n      .attr(\"class\", \"horizon\")\n      .attr(\"x1\", 0)\n      .attr(\"y1\", chartHeight / 2)\n      .attr(\"x2\", width - margin / 2)\n      .attr(\"y2\", chartHeight / 2);\n\n    this.annotate(marginLeft + barWidth * (stats.count() - 1) - 4, \"Start\");\n    if (stopped) {\n      this.annotate(marginLeft - barWidth - 8, \"End\");\n    }\n  };\n\n  this.render = function() {\n    svg.selectAll(\"g\").remove();\n    svg.selectAll(\"text\").remove();\n    chart.selectAll(\"rect\").remove();\n\n    chartIn = chart.append(\"g\");\n    chartOut = chart.append(\"g\");\n\n    rpsTextSize = Math.min(10 + height / 40, 20);\n\n    rowsPerSecondIn = svg.append(\"text\");\n    rowsPerSecondIn.style(\"font-size\", rpsTextSize + \"px\");\n\n    rowsPerSecondOut = svg.append(\"text\");\n    rowsPerSecondOut.style(\"font-size\", rpsTextSize + \"px\");\n\n    var sourceCircles = svg.selectAll(\".source\")\n      .data(data.sources)\n      .enter()\n      .append(\"g\")\n        .attr(\"class\", \"source\")\n        .attr(\"transform\", function(d, i) {\n          return \"translate(\" + (marginLeft + i * 24) + \", \" + remotesMargin + \")\";\n        })\n        .append(\"circle\");\n\n    sourceCircles.attr(\"cx\", \"0\").attr(\"cy\", \"0\").attr(\"r\", \"10\")\n      .attr(\"class\", function (d, i) {\n        return (i == data.sources.length - 1) ? \"source selected\" : \"source\";\n      })\n      .attr(\"stroke-width\", \"2\")\n      .on(\"mouseover\", function (d, i) {\n        sourceCircles.attr(\"class\", \"source\");\n        d3.select(this).attr(\"class\", \"source selected\");\n        sourceText.text(d);\n      });\n\n    var sourceText = svg\n      .append(\"text\")\n        .attr(\"y\", margin + 3).attr(\"x\", marginLeft + data.sources.length * 24)\n        .attr(\"class\", \"label\")\n        .text(function(d) { return data.sources[data.sources.length - 1]; });\n\n    rowsPerSecondIn\n      .attr(\"y\", margin + rpsTextSize + 5).attr(\"x\", marginLeft + data.sources.length * 24)\n      .attr(\"class\", \"rps\")\n      .text(self.formatRps(stats.latestRpsIn()) + \" rps\");\n\n    rowsPerSecondIn.append(\"title\").text(\"rows per second\");\n\n    var sinkCircles = svg.selectAll(\".sink\")\n      .data(data.sinks)\n      .enter()\n      .append(\"g\")\n        .attr(\"class\", \"sink\")\n        .attr(\"transform\", function(d, i) {\n          return \"translate(\" + (marginLeft + i * 24) + \",\"  + (height - remotesMargin) + \")\";\n        })\n        .append(\"circle\");\n\n    sinkCircles.attr(\"cx\", \"0\").attr(\"cy\", \"0\").attr(\"r\", \"10\")\n      .attr(\"class\", function (d, i) {\n        return (i == data.sinks.length - 1) ? \"sink selected\" : \"sink\";\n      })\n      .attr(\"stroke-width\", \"2\")\n      .on(\"mouseover\", function (d, i) {\n        sinkCircles.attr(\"class\", \"sink\");\n        d3.select(this).attr(\"class\", \"sink selected\");\n        sinkText.text(d);\n      });\n\n    var sinkText = svg\n      .append(\"text\")\n        .attr(\"y\", height - margin + 3).attr(\"x\", marginLeft + data.sinks.length * 24)\n        .attr(\"class\", \"label sinkText\")\n        .text(function(d) { return data.sinks[data.sinks.length - 1]; });\n\n    rowsPerSecondOut\n      .attr(\"y\", height - margin - 15).attr(\"x\", marginLeft + data.sinks.length * 24)\n      .attr(\"class\", \"rps\")\n      .text(self.formatRps(stats.latestRpsOut()) + \" rps\");\n\n    rowsPerSecondOut.append(\"title\").text(\"rows per second\");\n\n    this.update();\n  };\n}\n\nvar renderer = new StreamRenderer(stats);\n\nr2d3.onRender(function(data, svg, width, height, options) {\n  renderer.setSize(width, height);\n  renderer.render();\n});\n\nr2d3.onResize(function(width, height) {\n  renderer.setSize(width, height);\n  renderer.render();\n});\n\nfunction debug(msg) {\n  if (options !== null && \"debug\" in options) {\n    console.log(msg);\n  }\n}\n\nif (options !== null && \"demo\" in options && options.demo === true) {\n  setInterval(function() {\n    var data = {\n      rps: {\n        in: Math.random() * 100,\n        out: Math.random() * 100\n      }\n    };\n\n    debug(JSON.stringify(data));\n    stats.add(data.rps);\n    renderer.update();\n  }, 1000);\n}\nelse if (typeof(Shiny) !== \"undefined\") {\n  Shiny.addCustomMessageHandler(\"sparklyr_stream_view\", function(data) {\n      debug(JSON.stringify(data));\n      stats.add(data.rps);\n      renderer.update();\n    }\n  );\n}\nelse if (data !== null && \"stats\" in data) {\n  var statsIdx = 0;\n  setInterval(function(data) {\n    return function() {\n      if (statsIdx >= data.stats.length) {\n        var stopped = renderer.stopped();\n        renderer.stop();\n        if (!stopped) renderer.update();\n        return;\n      }\n\n      var d = data.stats[statsIdx];\n\n      debug(JSON.stringify(d));\n      stats.add(d.rps);\n\n      renderer.setAnimateClass(\"animateFast\");\n      renderer.update();\n\n      statsIdx += 1;\n    };\n  }(data), 100);\n}\n};","style":"/* R2D3 Source File:  /Library/Frameworks/R.framework/Versions/3.5/Resources/library/sparklyr/streams/stream.css */\n.root {\n  position: absolute;\n}\n\nsvg {\n  font: 12px sans-serif;\n  position: absolute;\n}\n\n.label {\n  fill: #666;\n}\n\n.rps {\n  fill: #777;\n  font: 20px sans-serif;\n}\n\n@-webkit-keyframes svgTranslate {\n    0% {\n        transform: translateX(0px);\n    }\n    100% {\n        transform: translateX(100px);\n    }\n}\n\n@-webkit-keyframes svgReset {\n    0% { transform: translateX(0); }\n    100% { transform: translateX(0px); }\n}\n\n@keyframes svgTranslate {\n    0%   { transform: translateX(0px) }\n    100% { transform: translateX(100px) }\n}\n\n@keyframes svgTranslateFast {\n    0%   { transform: translateX(0px) }\n    100% { transform: translateX(1000px) }\n}\n\n.chart {\n  position: absolute;\n}\n\n.chart.animate {\n  animation-name: svgTranslate;\n  animation-duration: 10s;\n  animation-timing-function: linear;\n  animation-delay: 0s;\n}\n\n.chart.animate-fast {\n  animation-name: svgTranslate;\n  animation-duration: 10s;\n  animation-timing-function: linear;\n  animation-delay: 0s;\n}\n\n.chart.stop{\n  transform: translateX(10px);\n}\n\n.barIn {\n  fill: #667292;\n}\n\n.barIn.selected {\n  fill: #263252;\n}\n\n.barOut {\n  fill: #8d9db6;\n}\n\n.barOut.selected {\n  fill: #4a5d76;\n}\n\n.source {\n  fill: #667292;\n  stroke: none;\n}\n\n.source .selected {\n  stroke: #667292;\n}\n\n.sink {\n  fill: #8d9db6;\n  stroke: none;\n}\n\n.sink .selected {\n  stroke: #8d9db6;\n}\n\n.tick {\n  stroke: none;\n  fill: #CDCDE6;\n}\n\n.horizon {\n  stroke: #CdCdE6;\n  stroke-width: 1;\n  stroke-dasharray: 2,2;\n}\n\n.annotation {\n  fill: #CdCdE6;\n}","version":5,"theme":{"default":{"background":"#FFFFFF","foreground":"#000000"},"runtime":null},"useShadow":true},"evals":[],"jsHooks":[]}</script>
<p class="caption">
FIGURE 11.1: Viewing a Spark Stream with sparklyr
</p>
</div>
<p>Notice that the rows-per-second in the destination stream are higher than the rows-per-second in the source stream; this is expected and desireable since Spark measures incoming rates from the source, but actual row processing times in the destination stream. For example, if 10 rows-per-second are written to the <code>source/</code> path, the incoming rate is 10 RPS. However, if it takes Spark only 0.01 seconds to write all those 10 rows, the output rate is 100 RPS.</p>
<p>Use <code>stream_stop()</code> to properly stop processing data from this stream:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb126-1" data-line-number="1"><span class="kw">stream_stop</span>(stream)</a></code></pre></div>
<p>In order to reproduce the above example, one needs to feed streaming data into the <code>source/</code> path. This was accomplished by running <code>stream_generate_test()</code> to produce a file every second containing lines of text that follow overlapping binomial distributions. In practice, you would connect to existing sources without having to generate data artificially. See <code>?stream_generate_test</code> for additional details and make sure the <code>later</code> package is installed.</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb127-1" data-line-number="1"><span class="kw">stream_generate_test</span>(<span class="kw">paste</span>(<span class="st">&quot;Row&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>), <span class="st">&quot;source/&quot;</span>)</a></code></pre></div>
<p>For the subsequent examples, a stream with one hundred rows of text will be used:</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb128-1" data-line-number="1"><span class="kw">writeLines</span>(<span class="kw">paste</span>(<span class="st">&quot;Row&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">100</span>), <span class="st">&quot;source/rows.txt&quot;</span>)</a></code></pre></div>
</div>
<div id="transformations" class="section level2">
<h2><span class="header-section-number">11.2</span> Transformations</h2>
<p>Streams can be transformed using <code>dplyr</code>, SQL, pipelines or R code. We can use as many transformations as needed in the same way that Spark data frames can be transformed with <code>sparklyr</code>. The transformation source can be streams or data frames but the output is always a stream. If needed, one can always take a snapshot from the destination stream and save the output as a data frame, which is what <code>sparklyr</code> will do for you if a destination stream is not specified. Conceptually, this looks as follows:</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-145"></span>
<div id="htmlwidget-14f1eff4be5206dadeaa" style="width:100%;height:280pt;" class="r2d3 html-widget"></div>
<script type="application/json" data-for="htmlwidget-14f1eff4be5206dadeaa">{"x":{"data":null,"type":"NULL","container":"svg","options":null,"script":"var d3Script = function(d3, r2d3, data, svg, width, height, options, theme, console) {\nthis.d3 = d3;\n/* R2D3 Source File:  images/06-connections-diagram.js */\n\nsvg.append(\"svg:defs\").append(\"svg:marker\")\n  .attr(\"id\", \"circle\")\n  .attr(\"refX\", 6)\n  .attr(\"refY\", 6)\n  .attr(\"markerWidth\", 12)\n  .attr(\"markerHeight\", 12)\n  .attr(\"orient\", \"auto\")\n  .append(\"circle\")\n  .attr(\"cx\", \"6\")\n  .attr(\"cy\", \"6\")\n  .attr(\"r\", \"3\")\n  .attr(\"class\", \"block-link\")\n  .attr(\"stroke-width\", 1);\n\nfunction diagramRoot(maxWidth) {\n  if (!maxWidth) maxWidth = 500;\n\n  var scaleX = 1;\n  var scaleY = 1;\n  height = height - 20;\n\n  var newWidth = width > maxWidth ? maxWidth : width;\n  var translateX = width > newWidth ? (width - newWidth) / 2 : 0;\n  var translateY = 10;\n  width = newWidth;\n\n  svg\n    .attr(\"font-size\", Math.min(width, 500) / 600 + \"em\")\n    .attr(\"font-family\", \"sans-serif\");\n\n  var root = svg.append(\"g\")\n    .attr(\"transform\", \"translate(\" + translateX + \",\" + translateY + \")scale(\" + scaleX + \",\" + scaleY + \")\");\n\n  return root;\n}\n\nfunction drawBlock(parent, block) {\n  if (!block.x) block.x = 0;\n  if (!block.y) block.y = 0;\n  if (!block.width) block.width = blockWidth;\n  if (!block.height) block.height = blockHeight;\n  if (!block.color) block.color = \"#bbcce0\";\n  if (!block.label) block.label = \"<label>\";\n  if (!block.style) block.style = \"block\";\n\n  var startX = block.x - block.width / 2;\n  var startY = block.y - block.height / 2;\n\n  parent.append(\"rect\")\n    .attr(\"x\", startX)\n    .attr(\"y\", startY)\n    .attr(\"width\", block.width)\n    .attr(\"height\", block.height)\n    .attr(\"class\", block.style);\n\n  var current = parent.append(\"text\")\n    .attr(\"x\", block.x)\n    .attr(\"y\", startY + 20)\n    .attr(\"fill\", \"white\")\n    .attr(\"text-anchor\", \"middle\")\n    .text(block.label);\n\n  if (block.childrens) {\n    for (var childIdx in block.childrens) {\n      var child = block.childrens[childIdx];\n\n      if (!child.width) child.width = block.width - 20;\n      if (!child.x) child.x = block.x;\n      if (child.position === undefined) child.position = childIdx;\n      if (child.style === undefined) child.style = \"block-children\";\n\n      var childBlock = {\n        x: child.x,\n        y: startY + 46 + child.position * 34,\n        width: child.width,\n        height: 30,\n        label: child.label,\n        style: child.style\n      };\n\n      drawBlock(parent, childBlock);\n    }\n  }\n\n  return block;\n}\n\nfunction linkBlocks(block1, block2, label) {\n  var block1right = block1.x + block1.width / 2;\n  var block2left = block2.x - block2.width / 2;\n  var block1bottom = block1.y + block1.height / 2;\n  var block2top = block2.y - block2.height / 2;\n\n  var horizontal = block1right < block2left;\n\n  root.append('line')\n    .attr(\"x1\", horizontal ? block1right : block1.x)\n    .attr(\"y1\", horizontal ? block1.y : block1bottom)\n    .attr(\"x2\", horizontal ? block2left : block2.x)\n    .attr(\"y2\", horizontal ? block2.y : block2top)\n  \t.attr(\"class\", \"block-link\")\n  \t.attr(\"stroke-width\", \"1\")\n  \t.attr(\"marker-start\", \"url(#circle)\")\n  \t.attr(\"marker-end\", \"url(#circle)\")\n  \t.attr(\"stroke-dasharray\", \"3,7\");\n\n  var labelFits = horizontal ?\n    Math.abs(block2left - block1right) > block1.width / 2 :\n    Math.abs(block2top - block1bottom) > 30;\n\n  if (label && labelFits) {\n    root.append('text')\n      .attr(\"dy\", (horizontal ? \"-\" : \"\") + \"0.4em\")\n      .attr(\"x\", block1right + (block2left - block1right) / 2)\n      .attr(\"y\", block1bottom + (block2top - block1bottom) / 2)\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"fill\", \"#759cc7\")\n      .text(label);\n  }\n}\nsvg = d3.select(svg.node());\n/* R2D3 Source File:  images/11-streaming-transformations.js */\n// !preview r2d3 dependencies=\"images/06-connections-diagram.js\", css=\"images/06-connections-diagram.css\"\n//\n// r2d3: https://rstudio.github.io/r2d3\n//\n\nvar root = diagramRoot(600);\nvar blockWidth = width / 3.8;\n\nvar totalWorkers = 2;\nvar blockHeight = 170;\n\nvar streamingSorucesBlock = drawBlock(root, {\n  x: blockWidth / 2,\n  y: blockHeight / 2,\n  height: blockHeight,\n  label: \"Streaming Sources\",\n  childrens: [\n    {label: \"Kafka\"},\n    {label: \"JDBC\"},\n    {label: \"CSV\"},\n    {label: \"...\"}\n  ]\n});\n\nvar staticSorucesBlock = drawBlock(root, {\n  x: blockWidth / 2,\n  y: height - blockHeight / 2,\n  height: blockHeight,\n  label: \"Data Sources\",\n  childrens: [\n    {label: \"Parquet\"},\n    {label: \"CSV\"},\n    {label: \"JDBC\"},\n    {label: \"...\"}\n  ]\n});\n\nvar transformationBlock = drawBlock(root, {\n  x: width / 2,\n  y: height / 2,\n  height: blockHeight,\n  label: \"Transformations\",\n  childrens: [\n    {label: \"dplyr\"},\n    {label: \"SQL\"},\n    {label: \"Pipeline\"},\n    {label: \"R\"}\n  ]\n});\n\nlinkBlocks(streamingSorucesBlock, transformationBlock);\nlinkBlocks(staticSorucesBlock, transformationBlock);\n\nvar destinationBlock = drawBlock(root, {\n  x: width - blockWidth / 2,\n  y: height / 2,\n  height: blockHeight,\n  label: \"Output Streams\",\n  childrens: [\n    {label: \"Kafka\"},\n    {label: \"Memory\"},\n    {label: \"CSV\"},\n    {label: \"...\"}\n  ]\n});\n\nlinkBlocks(transformationBlock, destinationBlock);\n};","style":"/* R2D3 Source File:  images/06-connections-diagram.css */\n.block {\n  fill: #bbcce0;\n}\n\n.block-children {\n  fill:  #93acc7;\n}\n\n.block-link {\n  fill: white;\n  stroke: #bbcce0;\n}","version":5,"theme":{"default":{"background":"#FFFFFF","foreground":"#000000"},"runtime":null},"useShadow":true},"evals":[],"jsHooks":[]}</script>
<p class="caption">
FIGURE 11.2: Streams Transformation Diagram
</p>
</div>
<div id="streams-dplyr" class="section level3">
<h3><span class="header-section-number">11.2.1</span> dplyr</h3>
<p>Using <code>dplyr</code>, we can process each row of the stream; for example, we can filter the stream to only the rows containing a number one:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb129-1" data-line-number="1"><span class="kw">library</span>(dplyr, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb129-2" data-line-number="2"></a>
<a class="sourceLine" id="cb129-3" data-line-number="3"><span class="kw">stream_read_text</span>(sc, <span class="st">&quot;source/&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(line <span class="op">%like%</span><span class="st"> &quot;%1%&quot;</span>)</a></code></pre></div>
<pre><code>## # Source: spark&lt;?&gt; [inf x 1]
##    line  
##  * &lt;chr&gt; 
##  1 Row 1 
##  2 Row 10
##  3 Row 11
##  4 Row 12
##  5 Row 13
##  6 Row 14
##  7 Row 15
##  8 Row 16
##  9 Row 17
## 10 Row 18
## # ... with more rows</code></pre>
<p>Since the destination was not specified, <code>sparklyr</code> creates a temporary memory stream and previews the contents of a stream by capturing a few seconds of streaming data.</p>
<p>We can also aggregate data with <code>dplyr</code>,</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb131-1" data-line-number="1"><span class="kw">stream_read_text</span>(sc, <span class="st">&quot;source/&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-2" data-line-number="2"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>())</a></code></pre></div>
<pre><code>## # Source: spark&lt;?&gt; [inf x 1]
##       n
## * &lt;dbl&gt;
## 1   100</code></pre>
<p>and even join across many concurrent streams:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb133-1" data-line-number="1"><span class="kw">left_join</span>(</a>
<a class="sourceLine" id="cb133-2" data-line-number="2">  <span class="kw">stream_read_text</span>(sc, <span class="st">&quot;source/&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">stream_watermark</span>(),</a>
<a class="sourceLine" id="cb133-3" data-line-number="3">  <span class="kw">stream_read_text</span>(sc, <span class="st">&quot;source/&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">stream_watermark</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">random =</span> <span class="kw">rand</span>()),</a>
<a class="sourceLine" id="cb133-4" data-line-number="4">)</a></code></pre></div>
<pre><code>## Joining, by = c(&quot;line&quot;, &quot;timestamp&quot;)</code></pre>
<pre><code>## # Source: spark&lt;?&gt; [inf x 3]
##    line   timestamp           random
##  * &lt;chr&gt;  &lt;dttm&gt;               &lt;dbl&gt;
##  1 Row 2  2018-11-17 22:29:34 0.420 
##  2 Row 9  2018-11-17 22:29:34 0.113 
##  3 Row 18 2018-11-17 22:29:34 0.695 
##  4 Row 19 2018-11-17 22:29:34 0.358 
##  5 Row 20 2018-11-17 22:29:34 0.0208
##  6 Row 23 2018-11-17 22:29:34 0.330 
##  7 Row 27 2018-11-17 22:29:34 0.619 
##  8 Row 38 2018-11-17 22:29:34 0.401 
##  9 Row 39 2018-11-17 22:29:34 0.767 
## 10 Row 44 2018-11-17 22:29:34 0.383 
## # ... with more rows</code></pre>
<p>However, some operations, require watermarks to define when to stop waiting for late data. You can specify watermarks in <code>sparklyr</code> using <code>stream_watermak()</code>, see also <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#handling-late-data-and-watermarking">handling late data</a> in Spark’s documentation.</p>
</div>
<div id="streams-pipelines" class="section level3">
<h3><span class="header-section-number">11.2.2</span> Pipelines</h3>
<p>Spark pipelines can be used for scoring streams, but not to train over streaming data. The former is fully supported while the latter is a feature under active development by the Spark community.</p>
<p>To use a pipeline for scoring a stream, first train a Spark pipeline over a static dataset. Once trained, save the pipeline, then reload and score over a stream as follows:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb136-1" data-line-number="1">fitted_pipeline &lt;-<span class="st"> </span><span class="kw">ml_load</span>(sc, <span class="st">&quot;iris-fitted/&quot;</span>)</a>
<a class="sourceLine" id="cb136-2" data-line-number="2"></a>
<a class="sourceLine" id="cb136-3" data-line-number="3"><span class="kw">stream_read_csv</span>(sc, <span class="st">&quot;iris-in&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb136-4" data-line-number="4"><span class="st">  </span><span class="kw">sdf_transform</span>(fitted_pipeline) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb136-5" data-line-number="5"><span class="st">  </span><span class="kw">stream_write_csv</span>(<span class="st">&quot;iris-out&quot;</span>)</a></code></pre></div>
</div>
<div id="streams-r" class="section level3">
<h3><span class="header-section-number">11.2.3</span> R Code</h3>
<p>Arbitrary R code can also be used to transform a stream with the use of <code>spark_apply()</code>. Following the same principles from executing R code over Spark data frames, for structured streams, <code>spark_apply()</code> runs R code over each executor in the cluster where data is available, this enables processing high-throughput streams and fullfill low-latency requirements.</p>
<p>The following example splits a stream of <code>Row #</code> line entries and adds jitter using R code:</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb137-1" data-line-number="1"><span class="kw">stream_read_text</span>(sc, <span class="st">&quot;source/&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-2" data-line-number="2"><span class="st">  </span><span class="kw">spark_apply</span>(<span class="op">~</span><span class="st"> </span><span class="kw">jitter</span>(<span class="kw">as.numeric</span>(<span class="kw">gsub</span>(<span class="st">&quot;Row &quot;</span>, <span class="st">&quot;&quot;</span>, .x<span class="op">$</span>text))))</a></code></pre></div>
<pre><code>## # Source: spark&lt;?&gt; [inf x 1]
## # ... with 1 variable: result &lt;dbl&gt;</code></pre>
</div>
</div>
<div id="shiny" class="section level2">
<h2><span class="header-section-number">11.3</span> Shiny</h2>
<p>Streams can be used with Shiny by making use of the <code>reactiveSpark()</code> to retrieve the stream as a reactive data source. Internally, <code>reactiveSpark()</code> makes use of <a href="https://shiny.rstudio.com/reference/shiny/latest/reactivePoll.html">reactivePoll()</a> to check the stream’s timestamp and collect the stream contents when needed.</p>
<p>The following Shiny application makes use of <code>reactiveSpark()</code> to view a Spark stream summarized with <code>dplyr</code>:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb139-1" data-line-number="1"><span class="kw">library</span>(shiny)</a>
<a class="sourceLine" id="cb139-2" data-line-number="2"><span class="kw">library</span>(sparklyr)</a>
<a class="sourceLine" id="cb139-3" data-line-number="3"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb139-4" data-line-number="4"></a>
<a class="sourceLine" id="cb139-5" data-line-number="5">sc &lt;-<span class="st"> </span><span class="kw">spark_connect</span>(<span class="dt">master =</span> <span class="st">&quot;local&quot;</span>)</a>
<a class="sourceLine" id="cb139-6" data-line-number="6"></a>
<a class="sourceLine" id="cb139-7" data-line-number="7">ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(</a>
<a class="sourceLine" id="cb139-8" data-line-number="8">  <span class="kw">sidebarLayout</span>(</a>
<a class="sourceLine" id="cb139-9" data-line-number="9">    <span class="kw">mainPanel</span>(</a>
<a class="sourceLine" id="cb139-10" data-line-number="10">      <span class="kw">tableOutput</span>(<span class="st">&quot;table&quot;</span>)</a>
<a class="sourceLine" id="cb139-11" data-line-number="11">    )</a>
<a class="sourceLine" id="cb139-12" data-line-number="12">  )</a>
<a class="sourceLine" id="cb139-13" data-line-number="13">)</a>
<a class="sourceLine" id="cb139-14" data-line-number="14"></a>
<a class="sourceLine" id="cb139-15" data-line-number="15">server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {</a>
<a class="sourceLine" id="cb139-16" data-line-number="16">  pollData &lt;-<span class="st"> </span><span class="kw">stream_read_text</span>(sc, <span class="st">&quot;source/&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb139-17" data-line-number="17"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb139-18" data-line-number="18"><span class="st">    </span><span class="kw">reactiveSpark</span>(<span class="dt">session =</span> session)</a>
<a class="sourceLine" id="cb139-19" data-line-number="19"></a>
<a class="sourceLine" id="cb139-20" data-line-number="20">  output<span class="op">$</span>table &lt;-<span class="st"> </span><span class="kw">renderTable</span>({</a>
<a class="sourceLine" id="cb139-21" data-line-number="21">    <span class="kw">pollData</span>()</a>
<a class="sourceLine" id="cb139-22" data-line-number="22">  })</a>
<a class="sourceLine" id="cb139-23" data-line-number="23">}</a>
<a class="sourceLine" id="cb139-24" data-line-number="24"></a>
<a class="sourceLine" id="cb139-25" data-line-number="25"><span class="kw">shinyApp</span>(<span class="dt">ui =</span> ui, <span class="dt">server =</span> server)</a></code></pre></div>
</div>
<div id="formats-1" class="section level2">
<h2><span class="header-section-number">11.4</span> Formats</h2>
<p>The following formats are available to read and write streaming data:</p>
<table>
<thead>
<tr class="header">
<th>Format</th>
<th>Read</th>
<th>Write</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>CSV</td>
<td>stream_read_csv</td>
<td>stream_write_csv</td>
</tr>
<tr class="even">
<td>JDBC</td>
<td>stream_read_jdbc</td>
<td>stream_write_jdbc</td>
</tr>
<tr class="odd">
<td>JSON</td>
<td>stream_read_json</td>
<td>stream_write_json</td>
</tr>
<tr class="even">
<td>Kafka</td>
<td>stream_read_kafka</td>
<td>stream_write_kafka</td>
</tr>
<tr class="odd">
<td>ORC</td>
<td>stream_read_orc</td>
<td>stream_write_orc</td>
</tr>
<tr class="even">
<td>Parquet</td>
<td>stream_read_parquet</td>
<td>stream_write_parquet</td>
</tr>
<tr class="odd">
<td>Text</td>
<td>stream_read_text</td>
<td>stream_write_text</td>
</tr>
<tr class="even">
<td>Memory</td>
<td></td>
<td>stream_write_memory</td>
</tr>
</tbody>
</table>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="distributed.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="contributing.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
